const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SceneMap.js","../run.js","./SceneTitle.js"])))=>i.map(i=>d[i]);
import{D as x,_ as o,S as k,a as G,L as I}from"../run.js";import{S as T,P as D,a as v,B as V}from"./SceneTitle.js";const p="http://www.w3.org/2000/svg";class O{svg;left;from;to;baseLeft;arrow;constructor(t,e,s){this.svg=R(t,e,s),this.from=s[0],this.to=s[1],this.baseLeft=s[2]?.multiplicity??1,this.left=this.baseLeft,this.arrow=s[2]?.arrow??!1,this.updateGraphic()}matches(t,e){const s=this.left>0&&this.from===t&&this.to===e;return this.arrow?s:s||this.left>0&&this.from===e&&this.to===t}decrementLeft(){this.left--,this.updateGraphic()}updateGraphic(){this.svg.dataset.left=String(this.left)}resetLeft(){this.left=this.baseLeft,this.updateGraphic()}}function R(i,t,e){const s=document.createElementNS(p,"polyline");return s.setAttribute("points",`${i[0]},${i[1]} ${(i[0]+t[0])/2},${(i[1]+t[1])/2} ${t[0]},${t[1]}`),s.setAttribute("stroke","currentColor"),s.setAttribute("stroke-width","3"),s.setAttribute("stroke-linecap","round"),s.setAttribute("data-from",String(e[0])),s.setAttribute("data-to",String(e[1])),s.classList.add("edge"),e[2]?.arrow&&s.setAttribute("marker-mid","url(#arrow-end)"),s}class z{svg;constructor(t){this.svg=$(t)}updateGraphic(t){this.svg.dataset.mode=t}}function $(i){const e=document.createElementNS(p,"rect");return e.setAttribute("width",String(48)),e.setAttribute("height",String(48)),e.setAttribute("x",String(i[0]-48/2)),e.setAttribute("y",String(i[1]-48/2)),e.setAttribute("fill","#f5f5f5"),e.setAttribute("stroke","#111"),e.setAttribute("stroke-width","0.5"),e.classList.add("vertex"),e}class q{onClear=()=>{};onMove=()=>{};svg;pen=document.createElement("span");penIndex=0;vertices=[];edges=[];firstClicked=!1;resizeObserver;constructor(t,e){this.svg=B(t,e),this.pen.classList.add("game-pen"),this.resizeObserver=new ResizeObserver(this.#i.bind(this)),this.resizeObserver.observe(document.body)}remove(){this.resizeObserver.unobserve(document.body)}render({vertices:t,edges:e}){this.vertices=t.map(s=>new z(s)),this.edges=e.map(s=>new O(t[s[0]],t[s[1]],s)),this.#e(),this.#t(),this.vertices.forEach((s,r)=>{s.svg.addEventListener("click",()=>{this.#r(r)})}),this.#s()}#e(){const t=this.svg.querySelector("g.game-edges");for(;t.firstChild;)t.removeChild(t.firstChild);this.edges.forEach(e=>t.appendChild(e.svg))}#t(){const t=this.svg.querySelector("g.game-vertices");for(;t.firstChild;)t.removeChild(t.firstChild);this.vertices.forEach(e=>t.appendChild(e.svg))}retry(){this.firstClicked=!1,this.penIndex=0,this.edges.forEach(t=>t.resetLeft()),this.#s()}#s(){this.#i(),this.#n()}#r(t){if(!this.firstClicked){this.penIndex=t,this.firstClicked=!0,this.onMove(),this.#s();return}if(t===this.penIndex)return;const e=this.#a(t,this.penIndex);e!==-1&&(this.onMove(),this.edges[e].decrementLeft(),this.penIndex=t,this.#s(),this.edges.every(s=>s.left===0)&&this.onClear())}#i(){if(!this.firstClicked){this.pen.style.left="calc(100% - 13dvh)",this.pen.style.top="calc(100% - 13dvh)";return}const e=this.vertices[this.penIndex].svg.getBoundingClientRect();this.pen.style.left=`${e.x+e.width/2}px`,this.pen.style.top=`${e.y+e.height/2}px`}#n(){if(!this.firstClicked){this.vertices.forEach(t=>t.updateGraphic("active"));return}this.vertices.forEach((t,e)=>{const s=this.#a(e,this.penIndex)!==-1;t.updateGraphic(e===this.penIndex?"current":s?"active":"normal")})}#a(t,e){return this.edges.findIndex(s=>s.matches(t,e))}}function B(i,t){const e=document.createElementNS(p,"svg");e.setAttribute("viewBox",`${-i/2} ${-t/2} ${i} ${t}`),e.classList.add("game-svg");const s=document.createElementNS(p,"g");s.classList.add("game-edges"),e.appendChild(s);const r=document.createElementNS(p,"g");return r.classList.add("game-vertices"),e.appendChild(r),e.appendChild(N(e)),e}function N(i){const t=document.createElementNS(i.namespaceURI,"marker");t.id="arrow-end",t.setAttribute("orient","auto"),t.setAttribute("markerWidth","4"),t.setAttribute("markerHeight","4"),t.setAttribute("refX","8"),t.setAttribute("refY","2");const e=document.createElementNS(i.namespaceURI,"path");return e.setAttribute("d",`
        M 4 0
        Q 2 1.3, 0 2
        Q 2 2.7, 4 4
        Z
        `),e.setAttribute("fill","currentColor"),t.appendChild(e),t}const a=(i,t)=>new U(i,t);a.arg=i=>a(Math.cos(i),Math.sin(i));class U{x;y;constructor(t,e){this.x=t,this.y=e}plus(t){return a(this.x+t.x,this.y+t.y)}minus(t){return a(this.x-t.x,this.y-t.y)}scaled(t){return a(this.x*t,this.y*t)}normalized(){const t=this.magnitude();return t==0?a(0,0):this.scaled(1/t)}rotated(t){return a(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t))}normal(){const t=this.normalized();return a(t.y,-t.x)}clone(){return a(this.x,this.y)}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}scale(t){this.x*=t,this.y*=t}rotate(t){const e=this.x*Math.cos(t)-this.y*Math.sin(t),s=this.x*Math.sin(t)+this.y*Math.cos(t);this.x=e,this.y=s}normalize(){const t=this.magnitude();t!=0&&(this.x/=t,this.y/=t)}magnitude(){return Math.hypot(this.x,this.y)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-t.x*this.y}arg(){return Math.atan2(this.y,this.x)}}class F{constructor(t,e,s){this.canvas=t,this.gainNode=e,this.ctx=t.getContext("2d"),this.analyser=s.createAnalyser(),this.analyser.fftSize=64,this.bufferLength=this.analyser.fftSize,this.dataArray=new Uint8Array(this.bufferLength),this.gainNode.connect(this.analyser)}ctx;analyser;dataArray;bufferLength;update(){this.analyser.getByteTimeDomainData(this.dataArray);const{width:t,height:e}=this.canvas;this.ctx.clearRect(0,0,t,e),this.ctx.lineWidth=2,this.ctx.strokeStyle="#8882",this.ctx.beginPath();const s=t/this.bufferLength;let r=0;for(let n=0;n<this.bufferLength;n++){const c=this.dataArray[n]/128*e/2;n===0?this.ctx.moveTo(r,c):this.ctx.lineTo(r,c),r+=s}this.ctx.lineTo(t,e/2),this.ctx.stroke()}drawFrequency(t,e,s,r,n){const h=this.analyser.frequencyBinCount,c=new Uint8Array(h);this.analyser.getByteFrequencyData(c);const l=a(e,s),m=Math.PI*2/h,{width:g,height:_}=this.canvas;this.ctx.clearRect(0,0,g,_),this.ctx.save(),this.ctx.strokeStyle=t,this.ctx.lineWidth=2;const S=16,u=1.5,f=(n-r)/u/S;for(let y=0;y<h;y++){const P=Math.floor(c[y]/(256/S)),b=y*m,w=a(1,0).rotated(b),A=a(1,0).rotated(b+m*3/4);for(let d=0;d<P;d++){const E=l.plus(w.scaled(r+f*d*u)),L=l.plus(w.scaled(r+f*(d*u+1))),C=l.plus(A.scaled(r+f*d*u)),M=l.plus(A.scaled(r+f*(d*u+1)));this.ctx.beginPath(),this.ctx.moveTo(E.x,E.y),this.ctx.lineTo(L.x,L.y),this.ctx.lineTo(M.x,M.y),this.ctx.lineTo(C.x,C.y),this.ctx.closePath(),this.ctx.stroke()}}this.ctx.restore()}}class H extends T{ready;#e=new D;#t=new q(400,300);mvUpdate=!0;constructor(t,e){super(),this.ready=this.#s(t,e)}async end(){this.mvUpdate=!1,this.#t.remove()}async#s(t,e){const s=await fetch("pages/game.html").then(r=>r.text());await this.#e.load(x.container,s),this.#r(t,e),this.#i(t,e),this.#n()}#r(t,e){this.#e.before("back",async()=>{const{SceneMap:s}=await o(async()=>{const{SceneMap:r}=await import("./SceneMap.js");return{SceneMap:r}},__vite__mapDeps([0,1,2]),import.meta.url);k.goto(()=>new s(t))}),this.#e.before("next",async()=>{const{SceneMap:s}=await o(async()=>{const{SceneMap:n}=await import("./SceneMap.js");return{SceneMap:n}},__vite__mapDeps([0,1,2]),import.meta.url);await k.goto(()=>new s(t));const r=await fetch("../../assets/stories/end.json").then(n=>n.json());G.say(...r[e])}),this.#e.before("retry",async()=>(this.#t.retry(),v.reset.play(),!0))}async#i(t,e){const s=this.#e.pages.get("first"),r=e>=13?e-13:e>=7?e-7:e,n=s.querySelector("#stage-id");n.textContent=`Stage: ${t}-${r}`;const h=s.querySelector("#center");h.appendChild(this.#t.svg),h.appendChild(this.#t.pen);const c=Object.assign({"../stages/Stage0.ts":()=>o(()=>import("./Stage0.js"),[],import.meta.url),"../stages/Stage1.ts":()=>o(()=>import("./Stage1.js"),[],import.meta.url),"../stages/Stage2.ts":()=>o(()=>import("./Stage2.js"),[],import.meta.url),"../stages/Stage3.ts":()=>o(()=>import("./Stage3.js"),[],import.meta.url),"../stages/Stage4.ts":()=>o(()=>import("./Stage4.js"),[],import.meta.url),"../stages/Stage5.ts":()=>o(()=>import("./Stage5.js"),[],import.meta.url),"../stages/Stage6.ts":()=>o(()=>import("./Stage6.js"),[],import.meta.url),"../stages/Stage7.ts":()=>o(()=>import("./Stage7.js"),[],import.meta.url),"../stages/Stage8.ts":()=>o(()=>import("./Stage8.js"),[],import.meta.url)}),l=`../stages/Stage${e}.ts`,{stage:m}=await c[l]();this.#t.render(m());const g=s.querySelector("#followed");this.#t.onClear=()=>{v.clear.play(),I.setStageData(e,{cleared:!0}),s.querySelector("[data-link=next]").classList.add("fade-in"),g.classList.remove("fade"),requestAnimationFrame(()=>{g.classList.add("fade")})},this.#t.onMove=()=>{v.move.play()}}#n(){const t=x.container.querySelector("canvas");t.width=x.container.clientWidth,t.height=x.container.clientHeight;const e=new F(t,V.wholeGain,V.context),s=()=>{e.drawFrequency("rgba(212, 209, 168, 0.07)",t.width/2,t.height/2,t.height/4,t.height),this.mvUpdate&&requestAnimationFrame(s)};requestAnimationFrame(s)}}export{H as SceneGame};
//# sourceMappingURL=SceneGame.js.map
