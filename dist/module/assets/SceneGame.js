const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SceneMap.js","../run.js","./SceneTitle.js","./Stage10.js"])))=>i.map(i=>d[i]);
import{D as x,_ as a,S as M,a as P,L as I}from"../run.js";import{S as O,P as D,a as v,B as T}from"./SceneTitle.js";const l="http://www.w3.org/2000/svg";class G{svg;left;valid;from;to;baseLeft;baseValid;arrow;constructor(t,e,s){this.svg=R(t,e,s),this.from=s[0],this.to=s[1],this.baseLeft=s[2]?.multiplicity??1,this.left=this.baseLeft,this.arrow=s[2]?.arrow??!1,this.baseValid=s[2]?.valid??!0,this.valid=this.baseValid,this.updateGraphic()}toggleValid(){this.valid=!this.valid,this.updateGraphic()}matches(t,e){if(!this.valid)return!1;const s=this.left>0&&this.from===t&&this.to===e;return this.arrow?s:s||this.left>0&&this.from===e&&this.to===t}decrementLeft(){this.left--,this.updateGraphic()}updateGraphic(){this.svg.dataset.left=String(this.left),this.svg.setAttribute("stroke-dasharray",this.valid?"":"6")}resetLeft(){this.left=this.baseLeft,this.valid=this.baseValid,this.updateGraphic()}}function R(i,t,e){const s=document.createElementNS(l,"polyline");return s.setAttribute("points",`${i[0]},${i[1]} ${(i[0]+t[0])/2},${(i[1]+t[1])/2} ${t[0]},${t[1]}`),s.setAttribute("stroke","currentColor"),s.setAttribute("stroke-width","3"),s.setAttribute("data-from",String(e[0])),s.setAttribute("data-to",String(e[1])),s.classList.add("edge"),e[2]?.arrow&&s.setAttribute("marker-mid","url(#arrow-end)"),s}class z{svg;switch;life;baseLife;rect;text;index;constructor(t,e){this.index=e,this.svg=document.createElementNS(l,"g"),this.rect=$(t),this.text=q(t),this.svg.appendChild(this.rect),this.svg.appendChild(this.text),this.switch=t[2]?.switch??!1,this.baseLife=t[2]?.life??1/0,this.life=this.baseLife}resetLife(){this.life=this.baseLife}updateGraphic(t){this.rect.dataset.mode=this.life>0?t:"no-available",this.rect.dataset.switch=String(this.switch),this.text.innerHTML=Number.isFinite(this.life)?String(Math.max(this.life,0)):""}}function $(i){const e=document.createElementNS(l,"rect");return e.setAttribute("width",String(48)),e.setAttribute("height",String(48)),e.setAttribute("x",String(i[0]-48/2)),e.setAttribute("y",String(i[1]-48/2)),e.setAttribute("fill","#f5f5f5"),e.setAttribute("stroke","#111"),e.setAttribute("stroke-width","0.5"),e.classList.add("vertex"),e}function q(i){const e=document.createElementNS(l,"text");return e.classList.add("game-text"),e.setAttribute("x",String(i[0]-48/2)),e.setAttribute("y",String(i[1]-48/8)),e}class N{onClear=()=>{};onMove=()=>{};onSwitch=()=>{};svg;pen=document.createElement("span");penIndex=0;vertices=[];edges=[];firstClicked=!1;resizeObserver;constructor(t,e){this.svg=B(t,e),this.pen.classList.add("game-pen"),this.resizeObserver=new ResizeObserver(this.#r.bind(this)),this.resizeObserver.observe(document.body)}remove(){this.resizeObserver.unobserve(document.body)}render({vertices:t,edges:e}){this.vertices=t.map((s,r)=>new z(s,r)),this.edges=e.map(s=>new G(t[s[0]],t[s[1]],s)),this.#e(),this.#t(),this.vertices.forEach((s,r)=>{s.svg.addEventListener("click",()=>{this.#a(r)})}),this.#s()}#e(){const t=this.svg.querySelector("g.game-edges");for(;t.firstChild;)t.removeChild(t.firstChild);this.edges.forEach(e=>t.appendChild(e.svg))}#t(){const t=this.svg.querySelector("g.game-vertices");for(;t.firstChild;)t.removeChild(t.firstChild);this.vertices.forEach(e=>t.appendChild(e.svg))}retry(){this.firstClicked=!1,this.penIndex=0,this.edges.forEach(t=>t.resetLeft()),this.vertices.forEach(t=>t.resetLife()),this.#s()}#s(){this.#r(),this.#h()}#a(t){if(!this.firstClicked){this.firstClicked=!0,this.#i(t);return}if(this.vertices[t].life<=0||t===this.penIndex)return;const e=this.#n(t,this.penIndex);e!==-1&&(this.edges[e].decrementLeft(),this.#i(t))}#i(t){this.onMove(),this.vertices.forEach(e=>e.life--),this.vertices[t].switch&&(this.edges.forEach(e=>e.toggleValid()),this.onSwitch()),this.penIndex=t,this.#s(),this.edges.every(e=>e.left===0)&&this.onClear()}#r(){if(!this.firstClicked){this.pen.style.left="calc(100% - 13dvh)",this.pen.style.top="calc(100% - 13dvh)";return}const e=this.vertices[this.penIndex].svg.getBoundingClientRect();this.pen.style.left=`${e.x+e.width/2}px`,this.pen.style.top=`${e.y+e.height/2}px`}#h(){if(!this.firstClicked){this.vertices.forEach(t=>t.updateGraphic("active"));return}this.vertices.forEach((t,e)=>{const s=this.#n(e,this.penIndex)!==-1;t.updateGraphic(e===this.penIndex?"current":s?"active":"normal")})}#n(t,e){return this.edges.findIndex(s=>s.matches(t,e))}}function B(i,t){const e=document.createElementNS(l,"svg");e.setAttribute("viewBox",`${-i/2} ${-t/2} ${i} ${t}`),e.classList.add("game-svg");const s=document.createElementNS(l,"g");s.classList.add("game-edges"),e.appendChild(s);const r=document.createElementNS(l,"g");return r.classList.add("game-vertices"),e.appendChild(r),e.appendChild(F(e)),e}function F(i){const t=document.createElementNS(i.namespaceURI,"marker");t.id="arrow-end",t.setAttribute("orient","auto"),t.setAttribute("markerWidth","4"),t.setAttribute("markerHeight","4"),t.setAttribute("refX","6"),t.setAttribute("refY","2");const e=document.createElementNS(i.namespaceURI,"path");return e.setAttribute("d",`
        M 4 0
        Q 2 1.3, 0 2
        Q 2 2.7, 4 4
        Z
        `),e.setAttribute("fill","currentColor"),t.appendChild(e),t}const n=(i,t)=>new U(i,t);n.arg=i=>n(Math.cos(i),Math.sin(i));class U{x;y;constructor(t,e){this.x=t,this.y=e}get l(){return[this.x,this.y]}plus(t){return n(this.x+t.x,this.y+t.y)}minus(t){return n(this.x-t.x,this.y-t.y)}scaled(t){return n(this.x*t,this.y*t)}normalized(){const t=this.magnitude();return t==0?n(0,0):this.scaled(1/t)}rotated(t){return n(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t))}normal(){const t=this.normalized();return n(t.y,-t.x)}clone(){return n(this.x,this.y)}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}scale(t){this.x*=t,this.y*=t}rotate(t){const e=this.x*Math.cos(t)-this.y*Math.sin(t),s=this.x*Math.sin(t)+this.y*Math.cos(t);this.x=e,this.y=s}normalize(){const t=this.magnitude();t!=0&&(this.x/=t,this.y/=t)}magnitude(){return Math.hypot(this.x,this.y)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-t.x*this.y}arg(){return Math.atan2(this.y,this.x)}}class j{constructor(t,e,s){this.canvas=t,this.gainNode=e,this.ctx=t.getContext("2d"),this.analyser=s.createAnalyser(),this.analyser.fftSize=64,this.bufferLength=this.analyser.fftSize,this.dataArray=new Uint8Array(this.bufferLength),this.gainNode.connect(this.analyser)}ctx;analyser;dataArray;bufferLength;update(){this.analyser.getByteTimeDomainData(this.dataArray);const{width:t,height:e}=this.canvas;this.ctx.clearRect(0,0,t,e),this.ctx.lineWidth=2,this.ctx.strokeStyle="#8882",this.ctx.beginPath();const s=t/this.bufferLength;let r=0;for(let o=0;o<this.bufferLength;o++){const c=this.dataArray[o]/128*e/2;o===0?this.ctx.moveTo(r,c):this.ctx.lineTo(r,c),r+=s}this.ctx.lineTo(t,e/2),this.ctx.stroke()}drawFrequency(t,e,s,r,o){const h=this.analyser.frequencyBinCount,c=new Uint8Array(h);this.analyser.getByteFrequencyData(c);const d=n(e,s),g=Math.PI*2/h,{width:p,height:_}=this.canvas;this.ctx.clearRect(0,0,p,_),this.ctx.save(),this.ctx.strokeStyle=t,this.ctx.lineWidth=2;const S=16,m=1.5,f=(o-r)/m/S;for(let y=0;y<h;y++){const k=Math.floor(c[y]/(256/S)),b=y*g,w=n(1,0).rotated(b),E=n(1,0).rotated(b+g*3/4);for(let u=0;u<k;u++){const A=d.plus(w.scaled(r+f*u*m)),L=d.plus(w.scaled(r+f*(u*m+1))),C=d.plus(E.scaled(r+f*u*m)),V=d.plus(E.scaled(r+f*(u*m+1)));this.ctx.beginPath(),this.ctx.moveTo(A.x,A.y),this.ctx.lineTo(L.x,L.y),this.ctx.lineTo(V.x,V.y),this.ctx.lineTo(C.x,C.y),this.ctx.closePath(),this.ctx.stroke()}}this.ctx.restore()}}class W extends O{ready;#e=new D;#t=new N(400,300);mvUpdate=!0;constructor(t,e){super(),this.ready=this.#s(t,e)}async end(){this.mvUpdate=!1,this.#t.remove()}async#s(t,e){const s=await fetch("assets/pages/game.html").then(r=>r.text());await this.#e.load(x.container,s),this.#a(t,e),this.#i(t,e),this.#r()}#a(t,e){this.#e.before("back",async()=>{const{SceneMap:s}=await a(async()=>{const{SceneMap:r}=await import("./SceneMap.js");return{SceneMap:r}},__vite__mapDeps([0,1,2]),import.meta.url);M.goto(()=>new s(t))}),this.#e.before("next",async()=>{const{SceneMap:s}=await a(async()=>{const{SceneMap:h}=await import("./SceneMap.js");return{SceneMap:h}},__vite__mapDeps([0,1,2]),import.meta.url);await M.goto(()=>new s(t));const r=e*2+1,o=await fetch("../../assets/stories/story.json").then(h=>h.json());P.say(...o[r])}),this.#e.before("retry",async()=>(this.#t.retry(),v.reset.play(),!0))}async#i(t,e){const s=this.#e.pages.get("first"),r=e>=13?e-13:e>=7?e-7:e,o=s.querySelector("#stage-id");o.textContent=`Stage: ${t}-${r}`;const h=s.querySelector("#center");h.appendChild(this.#t.svg),h.appendChild(this.#t.pen);const c=Object.assign({"../stages/Stage0.ts":()=>a(()=>import("./Stage0.js"),[],import.meta.url),"../stages/Stage1.ts":()=>a(()=>import("./Stage1.js"),[],import.meta.url),"../stages/Stage10.ts":()=>a(()=>import("./Stage10.js"),__vite__mapDeps([3,1,2]),import.meta.url),"../stages/Stage11.ts":()=>a(()=>import("./Stage11.js"),[],import.meta.url),"../stages/Stage12.ts":()=>a(()=>import("./Stage12.js"),[],import.meta.url),"../stages/Stage2.ts":()=>a(()=>import("./Stage2.js"),[],import.meta.url),"../stages/Stage3.ts":()=>a(()=>import("./Stage3.js"),[],import.meta.url),"../stages/Stage4.ts":()=>a(()=>import("./Stage4.js"),[],import.meta.url),"../stages/Stage5.ts":()=>a(()=>import("./Stage5.js"),[],import.meta.url),"../stages/Stage6.ts":()=>a(()=>import("./Stage6.js"),[],import.meta.url),"../stages/Stage7.ts":()=>a(()=>import("./Stage7.js"),[],import.meta.url),"../stages/Stage8.ts":()=>a(()=>import("./Stage8.js"),[],import.meta.url),"../stages/Stage9.ts":()=>a(()=>import("./Stage9.js"),[],import.meta.url)}),d=`../stages/Stage${e}.ts`,{stage:g}=await c[d]();this.#t.render(g());const p=s.querySelector("#followed");this.#t.onClear=()=>{v.clear.play(),I.setStageData(e,{cleared:!0}),s.querySelector("[data-link=next]").classList.add("fade-in"),p.classList.remove("fade"),requestAnimationFrame(()=>{p.classList.add("fade")})},this.#t.onSwitch=()=>{v.switch.play()},this.#t.onMove=()=>{v.move.play()}}#r(){const t=x.container.querySelector("canvas");t.width=x.container.clientWidth*.9,t.height=x.container.clientHeight;const e=new j(t,T.wholeGain,T.context),s=()=>{e.drawFrequency("rgba(212, 209, 168, 0.07)",t.width/2,t.height/2,t.height/4,t.height),this.mvUpdate&&requestAnimationFrame(s)};requestAnimationFrame(s)}}const X=Object.freeze(Object.defineProperty({__proto__:null,SceneGame:W},Symbol.toStringTag,{value:"Module"}));export{X as S,n as v};
//# sourceMappingURL=SceneGame.js.map
