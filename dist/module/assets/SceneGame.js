const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SceneMap.js","../run.js","./SceneTitle.js","./SceneEnd.js","./Stage10.js"])))=>i.map(i=>d[i]);
import{D as u,A as P,B as l,S as E,_ as a,a as D,L as R}from"../run.js";import{S as I,P as G,a as y}from"./SceneTitle.js";import{M as v}from"./SceneMap.js";const m="http://www.w3.org/2000/svg";class ${svg;left;valid;from;to;baseLeft;baseValid;arrow;constructor(t,e,s){this.svg=z(t,e,s),this.from=s[0],this.to=s[1],this.baseLeft=s[2]?.multiplicity??1,this.left=this.baseLeft,this.arrow=s[2]?.arrow??!1,this.baseValid=s[2]?.valid??!0,this.valid=this.baseValid,this.updateGraphic()}toggleValid(){this.valid=!this.valid,this.updateGraphic()}matches(t,e){if(!this.valid)return!1;const s=this.left>0&&this.from===t&&this.to===e;return this.arrow?s:s||this.left>0&&this.from===e&&this.to===t}decrementLeft(){this.left--,this.updateGraphic()}updateGraphic(){this.svg.dataset.left=String(this.left),this.svg.setAttribute("stroke-dasharray",this.valid?"":"6")}resetLeft(){this.left=this.baseLeft,this.valid=this.baseValid,this.updateGraphic()}}function z(i,t,e){const s=document.createElementNS(m,"polyline");return s.setAttribute("points",`${i[0]},${i[1]} ${(i[0]+t[0])/2},${(i[1]+t[1])/2} ${t[0]},${t[1]}`),s.setAttribute("stroke","currentColor"),s.setAttribute("stroke-width","3"),s.setAttribute("data-from",String(e[0])),s.setAttribute("data-to",String(e[1])),s.classList.add("edge"),e[2]?.arrow&&s.setAttribute("marker-mid","url(#arrow-end)"),s}class B{svg;switch;life;baseLife;rect;text;index;constructor(t,e){this.index=e,this.svg=document.createElementNS(m,"g"),this.rect=q(t),this.text=N(t),this.svg.appendChild(this.rect),this.svg.appendChild(this.text),this.switch=t[2]?.switch??!1,this.baseLife=t[2]?.life??1/0,this.life=this.baseLife}resetLife(){this.life=this.baseLife}updateGraphic(t){this.rect.dataset.mode=this.life>0?t:"no-available",this.rect.dataset.switch=String(this.switch),this.text.innerHTML=Number.isFinite(this.life)?String(Math.max(this.life,0)):""}}function q(i){const e=document.createElementNS(m,"rect");return e.setAttribute("width",String(48)),e.setAttribute("height",String(48)),e.setAttribute("x",String(i[0]-48/2)),e.setAttribute("y",String(i[1]-48/2)),e.setAttribute("fill","#f5f5f5"),e.setAttribute("stroke","#111"),e.setAttribute("stroke-width","0.5"),e.classList.add("vertex"),e}function N(i){const e=document.createElementNS(m,"text");return e.classList.add("game-text"),e.setAttribute("x",String(i[0]-48/2)),e.setAttribute("y",String(i[1]-48/8)),e}class F{onClear=()=>{};onMove=()=>{};onSwitch=()=>{};svg;pen=document.createElement("span");penIndex=0;vertices=[];edges=[];firstClicked=!1;resizeObserver;constructor(t,e){this.svg=U(t,e),this.pen.classList.add("game-pen"),this.resizeObserver=new ResizeObserver(this.#r.bind(this)),this.resizeObserver.observe(document.body)}remove(){this.resizeObserver.unobserve(document.body)}render({vertices:t,edges:e}){this.vertices=t.map((s,r)=>new B(s,r)),this.edges=e.map(s=>new $(t[s[0]],t[s[1]],s)),this.#e(),this.#t(),this.vertices.forEach((s,r)=>{s.svg.addEventListener("click",()=>{this.#n(r)})}),this.#s()}#e(){const t=this.svg.querySelector("g.game-edges");for(;t.firstChild;)t.removeChild(t.firstChild);this.edges.forEach(e=>t.appendChild(e.svg))}#t(){const t=this.svg.querySelector("g.game-vertices");for(;t.firstChild;)t.removeChild(t.firstChild);this.vertices.forEach(e=>t.appendChild(e.svg))}retry(){this.firstClicked=!1,this.penIndex=0,this.edges.forEach(t=>t.resetLeft()),this.vertices.forEach(t=>t.resetLife()),this.#s()}#s(){this.#r(),this.#o()}#n(t){if(!this.firstClicked){this.firstClicked=!0,this.#i(t);return}if(this.vertices[t].life<=0||t===this.penIndex)return;const e=this.#a(t,this.penIndex);e!==-1&&(this.edges[e].decrementLeft(),this.#i(t))}#i(t){this.onMove(),this.vertices.forEach(e=>e.life--),this.vertices[t].switch&&(this.edges.forEach(e=>e.toggleValid()),this.onSwitch()),this.penIndex=t,this.#s(),this.edges.every(e=>e.left===0)&&this.onClear()}#r(){if(!this.firstClicked){this.pen.style.left="calc(100% - 15dvh)",this.pen.style.top="calc(100% - 26dvh)";return}const e=this.vertices[this.penIndex].svg.getBoundingClientRect();this.pen.style.left=`${e.x+e.width/2}px`,this.pen.style.top=`${e.y+e.height/2}px`}#o(){if(!this.firstClicked){this.vertices.forEach(t=>t.updateGraphic("active"));return}this.vertices.forEach((t,e)=>{const s=this.#a(e,this.penIndex)!==-1;t.updateGraphic(e===this.penIndex?"current":s?"active":"normal")})}#a(t,e){return this.edges.findIndex(s=>s.matches(t,e))}}function U(i,t){const e=document.createElementNS(m,"svg");e.setAttribute("viewBox",`${-i/2} ${-t/2} ${i} ${t}`),e.classList.add("game-svg");const s=document.createElementNS(m,"g");s.classList.add("game-edges"),e.appendChild(s);const r=document.createElementNS(m,"g");return r.classList.add("game-vertices"),e.appendChild(r),e.appendChild(W(e)),e}function W(i){const t=document.createElementNS(i.namespaceURI,"marker");t.id="arrow-end",t.setAttribute("orient","auto"),t.setAttribute("markerWidth","4"),t.setAttribute("markerHeight","4"),t.setAttribute("refX","6"),t.setAttribute("refY","2");const e=document.createElementNS(i.namespaceURI,"path");return e.setAttribute("d",`
        M 4 0
        Q 2 1.3, 0 2
        Q 2 2.7, 4 4
        Z
        `),e.setAttribute("fill","currentColor"),t.appendChild(e),t}function H(i,{particleCount:t=150,durationMs:e=2e3}={}){const s=`
        .confetti {
            position: absolute;
            width: 2dvh;
            height: 2dvh;
            top: -100%;
            pointer-events: none;
        }
    `,r=document.createElement("style");r.innerHTML=s,i.appendChild(r);const o=["#ff4d4f","#40a9ff","#73d13d","#ffd666","#9254de","#ff85c0"];Array.from({length:t}).forEach(()=>{const n=document.createElement("span");n.classList.add("confetti"),n.style.left=`${Math.random()*100}%`,n.style.backgroundColor=o[Math.floor(Math.random()*o.length)];const c=Math.random()*100,d=(Math.random()*2-1)*25,p=[{top:"-10%",left:`${c}%`,transform:"rotate3D(1,1,1,0deg)",opacity:"1"},{top:"100%",left:`${c+d}%`,transform:"rotate3D(1,1,1,720deg)",opacity:"0.5"}],f=n.animate(p,{delay:Math.random()*1500,duration:e*(1+(Math.random()*2-1)*.2)});f.onfinish=()=>{n.remove()},i.appendChild(n)})}const h=(i,t)=>new j(i,t);h.arg=i=>h(Math.cos(i),Math.sin(i));class j{x;y;constructor(t,e){this.x=t,this.y=e}get l(){return[this.x,this.y]}plus(t){return h(this.x+t.x,this.y+t.y)}minus(t){return h(this.x-t.x,this.y-t.y)}scaled(t){return h(this.x*t,this.y*t)}normalized(){const t=this.magnitude();return t==0?h(0,0):this.scaled(1/t)}rotated(t){return h(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t))}normal(){const t=this.normalized();return h(t.y,-t.x)}clone(){return h(this.x,this.y)}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}scale(t){this.x*=t,this.y*=t}rotate(t){const e=this.x*Math.cos(t)-this.y*Math.sin(t),s=this.x*Math.sin(t)+this.y*Math.cos(t);this.x=e,this.y=s}normalize(){const t=this.magnitude();t!=0&&(this.x/=t,this.y/=t)}magnitude(){return Math.hypot(this.x,this.y)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-t.x*this.y}arg(){return Math.atan2(this.y,this.x)}}class Q{constructor(t,e,s){this.canvas=t,this.gainNode=e,this.ctx=t.getContext("2d"),this.analyser=s.createAnalyser(),this.analyser.fftSize=64,this.bufferLength=this.analyser.fftSize,this.dataArray=new Uint8Array(this.bufferLength),this.gainNode.connect(this.analyser)}ctx;analyser;dataArray;bufferLength;update(){this.analyser.getByteTimeDomainData(this.dataArray);const{width:t,height:e}=this.canvas;this.ctx.clearRect(0,0,t,e),this.ctx.lineWidth=2,this.ctx.strokeStyle="#8882",this.ctx.beginPath();const s=t/this.bufferLength;let r=0;for(let o=0;o<this.bufferLength;o++){const c=this.dataArray[o]/128*e/2;o===0?this.ctx.moveTo(r,c):this.ctx.lineTo(r,c),r+=s}this.ctx.lineTo(t,e/2),this.ctx.stroke()}drawFrequency(t,e,s,r,o){const n=this.analyser.frequencyBinCount,c=new Uint8Array(n);this.analyser.getByteFrequencyData(c);const d=h(e,s),p=Math.PI*2/n,{width:f,height:b}=this.canvas;this.ctx.clearRect(0,0,f,b),this.ctx.save(),this.ctx.strokeStyle=t,this.ctx.lineWidth=2;const w=16,_=1.5,S=(o-r)/_/w;for(let x=0;x<n;x++){const k=Math.floor(c[x]/(256/w)),L=x*p,A=h(1,0).rotated(L),C=h(1,0).rotated(L+p*3/4);for(let g=0;g<k;g++){const M=d.plus(A.scaled(r+S*g*_)),V=d.plus(A.scaled(r+S*(g*_+1))),O=d.plus(C.scaled(r+S*g*_)),T=d.plus(C.scaled(r+S*(g*_+1)));this.ctx.beginPath(),this.ctx.moveTo(M.x,M.y),this.ctx.lineTo(V.x,V.y),this.ctx.lineTo(T.x,T.y),this.ctx.lineTo(O.x,O.y),this.ctx.closePath(),this.ctx.stroke()}}this.ctx.restore()}}class X extends I{ready;#e=new G;#t=new F(400,300);mvUpdate=!0;constructor(t,e){super(),this.ready=this.#s(t,e)}async end(){this.mvUpdate=!1,this.#t.remove()}async#s(t,e){const s=this.#n(e);await this.#e.loadFromFile(u.container,"assets/pages/game.html"),this.#i(t,e),this.#o(),await this.#r(t,e),await P.timeOver(5e3,s,()=>{console.warn("BGMの読み込みに時間掛かり過ぎ! スキップしました。")}),e===0&&this.#a()}async#n(t){t===v.BOSSES[0]||t===v.BOSSES[1]||t===v.BOSSES[2]?(await l.load("assets/sounds/bgm/まるでパズル感覚で.mp3"),l.glance("assets/sounds/bgm/まるでパズル感覚で.mp3",{loop:!0,loopStartS:11.111,loopEndS:82.222,volume:.8})):t===v.BOSSES[3]?(await l.load("assets/sounds/bgm/block.mp3"),l.glance("assets/sounds/bgm/block.mp3",{loop:!0,loopStartS:13.333,loopEndS:95,volume:.6})):(await l.load("assets/sounds/bgm/why_was_faith_lost.mp3"),l.glance("assets/sounds/bgm/why_was_faith_lost.mp3",{loop:!0,loopStartS:1.276}))}#i(t,e){this.#e.beforeEnter("back",async()=>{l.back(),E.goto(()=>a(async()=>{const{SceneMap:s}=await import("./SceneMap.js").then(r=>r.S);return{SceneMap:s}},__vite__mapDeps([0,1,2]),import.meta.url).then(({SceneMap:s})=>new s(t)))}),this.#e.beforeEnter("next",async()=>{if(e===v.BOSSES[3])await E.goto(async()=>a(async()=>{const{SceneEnd:s}=await import("./SceneEnd.js");return{SceneEnd:s}},__vite__mapDeps([3,1,2,0]),import.meta.url).then(({SceneEnd:s})=>new s));else{l.back();const s=await a(()=>import("./story.js"),[],import.meta.url);await E.goto(()=>a(async()=>{const{SceneMap:r}=await import("./SceneMap.js").then(o=>o.S);return{SceneMap:r}},__vite__mapDeps([0,1,2]),import.meta.url).then(({SceneMap:r})=>new r(t)),{afterLoad:()=>D.say(...s.default[e].end)})}}),this.#e.beforeEnter("retry",async()=>{this.#t.retry(),y.reset.play()})}async#r(t,e){const s=this.#e.getPage("first"),r=e>=13?e-13:e>=7?e-7:e,o=s.querySelector("#stage-id");o.textContent=`Stage: ${t}-${r}`;const n=s.querySelector("#center");n.appendChild(this.#t.svg),n.appendChild(this.#t.pen);const c=Object.assign({"../stages/Stage0.ts":()=>a(()=>import("./Stage0.js"),[],import.meta.url),"../stages/Stage1.ts":()=>a(()=>import("./Stage1.js"),[],import.meta.url),"../stages/Stage10.ts":()=>a(()=>import("./Stage10.js"),__vite__mapDeps([4,1,2,0]),import.meta.url),"../stages/Stage11.ts":()=>a(()=>import("./Stage11.js"),[],import.meta.url),"../stages/Stage12.ts":()=>a(()=>import("./Stage12.js"),[],import.meta.url),"../stages/Stage13.ts":()=>a(()=>import("./Stage13.js"),[],import.meta.url),"../stages/Stage14.ts":()=>a(()=>import("./Stage14.js"),[],import.meta.url),"../stages/Stage15.ts":()=>a(()=>import("./Stage15.js"),[],import.meta.url),"../stages/Stage16.ts":()=>a(()=>import("./Stage16.js"),[],import.meta.url),"../stages/Stage17.ts":()=>a(()=>import("./Stage17.js"),[],import.meta.url),"../stages/Stage2.ts":()=>a(()=>import("./Stage2.js"),[],import.meta.url),"../stages/Stage3.ts":()=>a(()=>import("./Stage3.js"),[],import.meta.url),"../stages/Stage4.ts":()=>a(()=>import("./Stage4.js"),[],import.meta.url),"../stages/Stage5.ts":()=>a(()=>import("./Stage5.js"),[],import.meta.url),"../stages/Stage6.ts":()=>a(()=>import("./Stage6.js"),[],import.meta.url),"../stages/Stage7.ts":()=>a(()=>import("./Stage7.js"),[],import.meta.url),"../stages/Stage8.ts":()=>a(()=>import("./Stage8.js"),[],import.meta.url),"../stages/Stage9.ts":()=>a(()=>import("./Stage9.js"),[],import.meta.url)}),d=`../stages/Stage${e}.ts`,{stage:p}=await c[d]();this.#t.render(p());const f=s.querySelector("#followed");this.#t.onClear=()=>{y.clear.play(),y.kansei.play(),R.setStageData(e,{cleared:!0}),s.querySelector("[data-link=next]").classList.add("fade-in"),f.classList.remove("fade"),requestAnimationFrame(()=>{f.classList.add("fade")}),H(u.container,{durationMs:2500})},this.#t.onSwitch=()=>{y.switch.play()},this.#t.onMove=()=>{y.move.play()}}#o(){const t=u.container.querySelector("canvas");t.width=u.container.clientWidth*.9,t.height=u.container.clientHeight;const e=new Q(t,l.gain,l.context),s=()=>{e.drawFrequency("rgba(212, 209, 168, 0.07)",t.width/2,t.height/2,t.height/4,t.height),this.mvUpdate&&requestAnimationFrame(s)};requestAnimationFrame(s)}#a(){const t=u.container.querySelector("rect");if(!t)throw new Error;const e=t.getClientRects()?.[0],s=document.createElement("span");s.classList.add("tutorial-arrow"),s.style.top=`${e.top}px`,s.style.left=`${e.left}px`,u.container.appendChild(s),t.addEventListener("click",()=>{s.style.opacity="0"},{once:!0})}}const K=Object.freeze(Object.defineProperty({__proto__:null,SceneGame:X},Symbol.toStringTag,{value:"Module"}));export{K as S,h as v};
//# sourceMappingURL=SceneGame.js.map
