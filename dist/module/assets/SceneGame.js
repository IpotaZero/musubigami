const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SceneMap.js","../run.js","./SceneTitle.js","./SceneEnd.js","./Stage10.js"])))=>i.map(i=>d[i]);
import{D as d,B as x,_ as a,a as S,b as P,S as _,L as k}from"../run.js";import{S as D,P as R}from"./SceneTitle.js";import{M as I}from"./SceneMap.js";const u="http://www.w3.org/2000/svg";class ${svg;left;valid;from;to;baseLeft;baseValid;arrow;constructor(t,e,s){this.svg=z(t,e,s),this.from=s[0],this.to=s[1],this.baseLeft=s[2]?.multiplicity??1,this.left=this.baseLeft,this.arrow=s[2]?.arrow??!1,this.baseValid=s[2]?.valid??!0,this.valid=this.baseValid,this.updateGraphic()}toggleValid(){this.valid=!this.valid,this.updateGraphic()}matches(t,e){if(!this.valid)return!1;const s=this.left>0&&this.from===t&&this.to===e;return this.arrow?s:s||this.left>0&&this.from===e&&this.to===t}decrementLeft(){this.left--,this.updateGraphic()}updateGraphic(){this.svg.dataset.left=String(this.left),this.svg.setAttribute("stroke-dasharray",this.valid?"":"6")}resetLeft(){this.left=this.baseLeft,this.valid=this.baseValid,this.updateGraphic()}}function z(i,t,e){const s=document.createElementNS(u,"polyline");return s.setAttribute("points",`${i[0]},${i[1]} ${(i[0]+t[0])/2},${(i[1]+t[1])/2} ${t[0]},${t[1]}`),s.setAttribute("stroke","currentColor"),s.setAttribute("stroke-width","3"),s.setAttribute("data-from",String(e[0])),s.setAttribute("data-to",String(e[1])),s.classList.add("edge"),e[2]?.arrow&&s.setAttribute("marker-mid","url(#arrow-end)"),s}class G{svg;switch;life;baseLife;rect;text;index;constructor(t,e){this.index=e,this.svg=document.createElementNS(u,"g"),this.rect=q(t),this.text=N(t),this.svg.appendChild(this.rect),this.svg.appendChild(this.text),this.switch=t[2]?.switch??!1,this.baseLife=t[2]?.life??1/0,this.life=this.baseLife}resetLife(){this.life=this.baseLife}updateGraphic(t){this.rect.dataset.mode=this.life>0?t:"no-available",this.rect.dataset.switch=String(this.switch),this.text.innerHTML=Number.isFinite(this.life)?String(Math.max(this.life,0)):""}}function q(i){const e=document.createElementNS(u,"rect");return e.setAttribute("width",String(48)),e.setAttribute("height",String(48)),e.setAttribute("x",String(i[0]-48/2)),e.setAttribute("y",String(i[1]-48/2)),e.setAttribute("fill","#f5f5f5"),e.setAttribute("stroke","#111"),e.setAttribute("stroke-width","0.5"),e.classList.add("vertex"),e}function N(i){const e=document.createElementNS(u,"text");return e.classList.add("game-text"),e.setAttribute("x",String(i[0]-48/2)),e.setAttribute("y",String(i[1]-48/8)),e}class B{onClear=()=>{};onMove=()=>{};onSwitch=()=>{};svg;pen=document.createElement("span");penIndex=0;vertices=[];edges=[];firstClicked=!1;resizeObserver;constructor(t,e){this.svg=F(t,e),this.pen.classList.add("game-pen"),this.resizeObserver=new ResizeObserver(this.#r.bind(this)),this.resizeObserver.observe(document.body)}remove(){this.resizeObserver.unobserve(document.body)}render({vertices:t,edges:e}){this.vertices=t.map((s,r)=>new G(s,r)),this.edges=e.map(s=>new $(t[s[0]],t[s[1]],s)),this.#e(),this.#t(),this.vertices.forEach((s,r)=>{s.svg.addEventListener("click",()=>{this.#a(r)})}),this.#s()}#e(){const t=this.svg.querySelector("g.game-edges");for(;t.firstChild;)t.removeChild(t.firstChild);this.edges.forEach(e=>t.appendChild(e.svg))}#t(){const t=this.svg.querySelector("g.game-vertices");for(;t.firstChild;)t.removeChild(t.firstChild);this.vertices.forEach(e=>t.appendChild(e.svg))}retry(){this.firstClicked=!1,this.penIndex=0,this.edges.forEach(t=>t.resetLeft()),this.vertices.forEach(t=>t.resetLife()),this.#s()}#s(){this.#r(),this.#n()}#a(t){if(!this.firstClicked){this.firstClicked=!0,this.#i(t);return}if(this.vertices[t].life<=0||t===this.penIndex)return;const e=this.#o(t,this.penIndex);e!==-1&&(this.edges[e].decrementLeft(),this.#i(t))}#i(t){this.onMove(),this.vertices.forEach(e=>e.life--),this.vertices[t].switch&&(this.edges.forEach(e=>e.toggleValid()),this.onSwitch()),this.penIndex=t,this.#s(),this.edges.every(e=>e.left===0)&&this.onClear()}#r(){if(!this.firstClicked){this.pen.style.left="calc(100% - 15dvh)",this.pen.style.top="calc(100% - 26dvh)";return}const e=this.vertices[this.penIndex].svg.getBoundingClientRect();this.pen.style.left=`${e.x+e.width/2}px`,this.pen.style.top=`${e.y+e.height/2}px`}#n(){if(!this.firstClicked){this.vertices.forEach(t=>t.updateGraphic("active"));return}this.vertices.forEach((t,e)=>{const s=this.#o(e,this.penIndex)!==-1;t.updateGraphic(e===this.penIndex?"current":s?"active":"normal")})}#o(t,e){return this.edges.findIndex(s=>s.matches(t,e))}}function F(i,t){const e=document.createElementNS(u,"svg");e.setAttribute("viewBox",`${-i/2} ${-t/2} ${i} ${t}`),e.classList.add("game-svg");const s=document.createElementNS(u,"g");s.classList.add("game-edges"),e.appendChild(s);const r=document.createElementNS(u,"g");return r.classList.add("game-vertices"),e.appendChild(r),e.appendChild(U(e)),e}function U(i){const t=document.createElementNS(i.namespaceURI,"marker");t.id="arrow-end",t.setAttribute("orient","auto"),t.setAttribute("markerWidth","4"),t.setAttribute("markerHeight","4"),t.setAttribute("refX","2"),t.setAttribute("refY","2");const e=document.createElementNS(i.namespaceURI,"path");return e.setAttribute("d",`
        M 4 0
        Q 2 1.3, 0 2
        Q 2 2.7, 4 4
        Z
        `),e.setAttribute("fill","currentColor"),t.appendChild(e),t}function W(i,{particleCount:t=150,durationMs:e=2e3}={}){const s=`
        .confetti {
            position: absolute;
            width: 2dvh;
            height: 2dvh;
            top: -100%;
            pointer-events: none;
        }
    `,r=document.createElement("style");r.innerHTML=s,i.appendChild(r);const o=["#ff4d4f","#40a9ff","#73d13d","#ffd666","#9254de","#ff85c0"];Array.from({length:t}).forEach(()=>{const n=document.createElement("span");n.classList.add("confetti"),n.style.left=`${Math.random()*100}%`,n.style.backgroundColor=o[Math.floor(Math.random()*o.length)];const c=Math.random()*100,l=(Math.random()*2-1)*25,m=[{top:"-10%",left:`${c}%`,transform:"rotate3D(1,1,1,0deg)",opacity:"1"},{top:"100%",left:`${c+l}%`,transform:"rotate3D(1,1,1,720deg)",opacity:"0.5"}],p=n.animate(m,{delay:Math.random()*1500,duration:e});p.onfinish=()=>{n.remove()},i.appendChild(n)})}const h=(i,t)=>new H(i,t);h.arg=i=>h(Math.cos(i),Math.sin(i));class H{x;y;constructor(t,e){this.x=t,this.y=e}get l(){return[this.x,this.y]}plus(t){return h(this.x+t.x,this.y+t.y)}minus(t){return h(this.x-t.x,this.y-t.y)}scaled(t){return h(this.x*t,this.y*t)}normalized(){const t=this.magnitude();return t==0?h(0,0):this.scaled(1/t)}rotated(t){return h(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t))}normal(){const t=this.normalized();return h(t.y,-t.x)}clone(){return h(this.x,this.y)}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}scale(t){this.x*=t,this.y*=t}rotate(t){const e=this.x*Math.cos(t)-this.y*Math.sin(t),s=this.x*Math.sin(t)+this.y*Math.cos(t);this.x=e,this.y=s}normalize(){const t=this.magnitude();t!=0&&(this.x/=t,this.y/=t)}magnitude(){return Math.hypot(this.x,this.y)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-t.x*this.y}arg(){return Math.atan2(this.y,this.x)}}class j{constructor(t,e,s){this.canvas=t,this.gainNode=e,this.ctx=t.getContext("2d"),this.analyser=s.createAnalyser(),this.analyser.fftSize=64,this.bufferLength=this.analyser.fftSize,this.dataArray=new Uint8Array(this.bufferLength),this.gainNode.connect(this.analyser)}ctx;analyser;dataArray;bufferLength;update(){this.analyser.getByteTimeDomainData(this.dataArray);const{width:t,height:e}=this.canvas;this.ctx.clearRect(0,0,t,e),this.ctx.lineWidth=2,this.ctx.strokeStyle="#8882",this.ctx.beginPath();const s=t/this.bufferLength;let r=0;for(let o=0;o<this.bufferLength;o++){const c=this.dataArray[o]/128*e/2;o===0?this.ctx.moveTo(r,c):this.ctx.lineTo(r,c),r+=s}this.ctx.lineTo(t,e/2),this.ctx.stroke()}drawFrequency(t,e,s,r,o){const n=this.analyser.frequencyBinCount,c=new Uint8Array(n);this.analyser.getByteFrequencyData(c);const l=h(e,s),m=Math.PI*2/n,{width:p,height:E}=this.canvas;this.ctx.clearRect(0,0,p,E),this.ctx.save(),this.ctx.strokeStyle=t,this.ctx.lineWidth=2;const b=16,g=1.5,y=(o-r)/g/b;for(let v=0;v<n;v++){const O=Math.floor(c[v]/(256/b)),w=v*m,L=h(1,0).rotated(w),A=h(1,0).rotated(w+m*3/4);for(let f=0;f<O;f++){const C=l.plus(L.scaled(r+y*f*g)),M=l.plus(L.scaled(r+y*(f*g+1))),V=l.plus(A.scaled(r+y*f*g)),T=l.plus(A.scaled(r+y*(f*g+1)));this.ctx.beginPath(),this.ctx.moveTo(C.x,C.y),this.ctx.lineTo(M.x,M.y),this.ctx.lineTo(T.x,T.y),this.ctx.lineTo(V.x,V.y),this.ctx.closePath(),this.ctx.stroke()}}this.ctx.restore()}}class Q extends D{ready;#e=new R;#t=new B(400,300);mvUpdate=!0;constructor(t,e){super(),this.ready=this.#s(t,e)}async end(){this.mvUpdate=!1,this.#t.remove()}async#s(t,e){await this.#e.loadFromFile(d.container,"assets/pages/game.html"),this.#a(t,e),this.#r(),await this.#i(t,e),e===0&&this.#n()}#a(t,e){this.#e.before("back",async()=>{x.back();const{SceneMap:s}=await a(async()=>{const{SceneMap:r}=await import("./SceneMap.js").then(o=>o.S);return{SceneMap:r}},__vite__mapDeps([0,1,2]),import.meta.url);S.goto(()=>new s(t))}),this.#e.before("next",async()=>{if(e===I.BOSSES[3]){const{SceneEnd:s}=await a(async()=>{const{SceneEnd:r}=await import("./SceneEnd.js");return{SceneEnd:r}},__vite__mapDeps([3,1,2,0]),import.meta.url);await S.goto(()=>new s)}else{x.back();const{SceneMap:s}=await a(async()=>{const{SceneMap:o}=await import("./SceneMap.js").then(n=>n.S);return{SceneMap:o}},__vite__mapDeps([0,1,2]),import.meta.url),r=await a(()=>import("./story.js"),[],import.meta.url);await S.goto(()=>new s(t),{afterLoad:()=>P.say(...r.default[e].end)})}}),this.#e.before("retry",async()=>(this.#t.retry(),_.reset.play(),!0))}async#i(t,e){const s=this.#e.pages.get("first"),r=e>=13?e-13:e>=7?e-7:e,o=s.querySelector("#stage-id");o.textContent=`Stage: ${t}-${r}`;const n=s.querySelector("#center");n.appendChild(this.#t.svg),n.appendChild(this.#t.pen);const c=Object.assign({"../stages/Stage0.ts":()=>a(()=>import("./Stage0.js"),[],import.meta.url),"../stages/Stage1.ts":()=>a(()=>import("./Stage1.js"),[],import.meta.url),"../stages/Stage10.ts":()=>a(()=>import("./Stage10.js"),__vite__mapDeps([4,1,2,0]),import.meta.url),"../stages/Stage11.ts":()=>a(()=>import("./Stage11.js"),[],import.meta.url),"../stages/Stage12.ts":()=>a(()=>import("./Stage12.js"),[],import.meta.url),"../stages/Stage13.ts":()=>a(()=>import("./Stage13.js"),[],import.meta.url),"../stages/Stage14.ts":()=>a(()=>import("./Stage14.js"),[],import.meta.url),"../stages/Stage15.ts":()=>a(()=>import("./Stage15.js"),[],import.meta.url),"../stages/Stage16.ts":()=>a(()=>import("./Stage16.js"),[],import.meta.url),"../stages/Stage17.ts":()=>a(()=>import("./Stage17.js"),[],import.meta.url),"../stages/Stage2.ts":()=>a(()=>import("./Stage2.js"),[],import.meta.url),"../stages/Stage3.ts":()=>a(()=>import("./Stage3.js"),[],import.meta.url),"../stages/Stage4.ts":()=>a(()=>import("./Stage4.js"),[],import.meta.url),"../stages/Stage5.ts":()=>a(()=>import("./Stage5.js"),[],import.meta.url),"../stages/Stage6.ts":()=>a(()=>import("./Stage6.js"),[],import.meta.url),"../stages/Stage7.ts":()=>a(()=>import("./Stage7.js"),[],import.meta.url),"../stages/Stage8.ts":()=>a(()=>import("./Stage8.js"),[],import.meta.url),"../stages/Stage9.ts":()=>a(()=>import("./Stage9.js"),[],import.meta.url)}),l=`../stages/Stage${e}.ts`,{stage:m}=await c[l]();this.#t.render(m());const p=s.querySelector("#followed");this.#t.onClear=()=>{_.clear.play(),_.kansei.play(),k.setStageData(e,{cleared:!0}),s.querySelector("[data-link=next]").classList.add("fade-in"),p.classList.remove("fade"),requestAnimationFrame(()=>{p.classList.add("fade")}),W(d.container,{durationMs:2500})},this.#t.onSwitch=()=>{_.switch.play()},this.#t.onMove=()=>{_.move.play()}}#r(){const t=d.container.querySelector("canvas");t.width=d.container.clientWidth*.9,t.height=d.container.clientHeight;const e=new j(t,x.gain,x.context),s=()=>{e.drawFrequency("rgba(212, 209, 168, 0.07)",t.width/2,t.height/2,t.height/4,t.height),this.mvUpdate&&requestAnimationFrame(s)};requestAnimationFrame(s)}#n(){const t=d.container.querySelector("rect");if(!t)throw new Error;const e=t.getClientRects()?.[0],s=document.createElement("span");s.classList.add("tutorial-arrow"),s.style.top=`${e.top}px`,s.style.left=`${e.left}px`,d.container.appendChild(s),t.addEventListener("click",()=>{s.style.opacity="0"},{once:!0})}}const J=Object.freeze(Object.defineProperty({__proto__:null,SceneGame:Q},Symbol.toStringTag,{value:"Module"}));export{J as S,h as v};
//# sourceMappingURL=SceneGame.js.map
