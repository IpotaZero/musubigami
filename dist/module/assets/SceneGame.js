const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SceneMap.js","../run.js","./SceneTitle.js"])))=>i.map(i=>d[i]);
import{D as x,_ as o,S as P,a as D,L as R}from"../run.js";import{S as $,P as q,a as v,B as T}from"./SceneTitle.js";const m="http://www.w3.org/2000/svg";class _{onClear=()=>{};onMove=()=>{};svg;pen=document.createElement("span");#t=0;#e=[];#n=[];#i=[];#s=[];#a=new AbortController;#r=!1;constructor(t=400,e=300){this.svg=document.createElementNS(m,"svg"),this.svg.setAttribute("viewBox",`${-t/2} ${-e/2} ${t} ${e}`),this.svg.style.display="block",this.svg.classList.add("game-svg");const s=document.createElementNS(m,"g");s.setAttribute("class","edges"),this.svg.appendChild(s);const i=document.createElementNS(m,"g");i.setAttribute("class","vertices"),this.svg.appendChild(i),this.pen.classList.add("game-pen"),this.svg.appendChild(_.#p(this.svg)),window.addEventListener("resize",()=>{this.#h()},{signal:this.#a.signal})}remove(){this.#a.abort()}render({vertices:t,edges:e}){this.#i=e;const s=this.svg.querySelector("g.edges"),i=this.svg.querySelector("g.vertices");for(;s.firstChild;)s.removeChild(s.firstChild);for(;i.firstChild;)i.removeChild(i.firstChild);for(const r of e){const n=t[r[0]],h=t[r[1]];if(!n||!h)continue;const c=this.#d(n,h,r);s.appendChild(c),this.#n.push(c)}for(const r of t){const n=this.#m(r);i.appendChild(n),this.#e.push(n)}this.#e.forEach((r,n)=>{r.addEventListener("click",()=>{this.#c(n)})}),this.#s=e.map(r=>r[2]??1),this.#o()}retry(){this.#r=!1,this.#t=0,this.#s=this.#i.map(t=>t[2]??1),this.#o()}#o(){this.#u(),this.#h(),this.#l()}#c(t){if(!this.#r){this.#t=t,this.#r=!0,this.onMove(),this.#o();return}if(t===this.#t)return;const e=this.#i.findIndex((s,i)=>this.#s[i]===0?!1:s[3]?s[1]===this.#t&&s[0]===t:s[0]===this.#t&&s[1]===t||s[1]===this.#t&&s[0]===t);e!==-1&&(this.onMove(),this.#s[e]--,this.#t=t,this.#o(),this.#s.every(s=>s===0)&&this.onClear())}#h(){if(!this.#r){this.pen.style.left="calc(100% - 13dvh)",this.pen.style.top="calc(100% - 13dvh)";return}const e=this.#e[this.#t].getBoundingClientRect();this.pen.style.left=`${e.x+e.width/2}px`,this.pen.style.top=`${e.y+e.height/2}px`}#l(){if(!this.#r){this.#e.forEach(t=>t.dataset.active="true");return}this.#e.forEach((t,e)=>{const s=this.#i.some((i,r)=>e===this.#t||this.#s[r]===0?!1:i[3]?i[1]===this.#t&&i[0]===e:i[0]===this.#t&&i[1]===e||i[1]===this.#t&&i[0]===e);t.dataset.active=String(s),t.dataset.current=String(e===this.#t)})}#u(){this.#n.forEach((t,e)=>{t.dataset.left=String(this.#s[e])})}#d(t,e,s){const i=document.createElementNS(m,"polyline");return i.setAttribute("points",`${t[0]},${t[1]} ${(t[0]+e[0])/2},${(t[1]+e[1])/2} ${e[0]},${e[1]}`),i.setAttribute("stroke","currentColor"),i.setAttribute("stroke-width","3"),i.setAttribute("stroke-linecap","round"),i.setAttribute("data-from",String(s[0])),i.setAttribute("data-to",String(s[1])),i.classList.add("edge"),s[3]&&i.setAttribute("marker-mid","url(#arrow-end)"),i}#m(t){const s=document.createElementNS(m,"rect");return s.setAttribute("width",String(48)),s.setAttribute("height",String(48)),s.setAttribute("x",String(t[0]-48/2)),s.setAttribute("y",String(t[1]-48/2)),s.setAttribute("fill","#f5f5f5"),s.setAttribute("stroke","#111"),s.setAttribute("stroke-width","0.5"),s.classList.add("vertex"),s}static#p(t){const e=document.createElementNS(t.namespaceURI,"marker");e.id="arrow-end",e.setAttribute("orient","auto"),e.setAttribute("markerWidth","4"),e.setAttribute("markerHeight","4"),e.setAttribute("refX","8"),e.setAttribute("refY","2");const s=document.createElementNS(t.namespaceURI,"path");return s.setAttribute("d",`M 4 0
             Q 2 1.3, 0 2
             Q 2 2.7, 4 4
             Z`),s.setAttribute("fill","currentColor"),e.appendChild(s),e}}const a=(l,t)=>new z(l,t);a.arg=l=>a(Math.cos(l),Math.sin(l));class z{x;y;constructor(t,e){this.x=t,this.y=e}plus(t){return a(this.x+t.x,this.y+t.y)}minus(t){return a(this.x-t.x,this.y-t.y)}scaled(t){return a(this.x*t,this.y*t)}normalized(){const t=this.magnitude();return t==0?a(0,0):this.scaled(1/t)}rotated(t){return a(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t))}normal(){const t=this.normalized();return a(t.y,-t.x)}clone(){return a(this.x,this.y)}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}scale(t){this.x*=t,this.y*=t}rotate(t){const e=this.x*Math.cos(t)-this.y*Math.sin(t),s=this.x*Math.sin(t)+this.y*Math.cos(t);this.x=e,this.y=s}normalize(){const t=this.magnitude();t!=0&&(this.x/=t,this.y/=t)}magnitude(){return Math.hypot(this.x,this.y)}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-t.x*this.y}arg(){return Math.atan2(this.y,this.x)}}class O{constructor(t,e,s){this.canvas=t,this.gainNode=e,this.ctx=t.getContext("2d"),this.analyser=s.createAnalyser(),this.analyser.fftSize=64,this.bufferLength=this.analyser.fftSize,this.dataArray=new Uint8Array(this.bufferLength),this.gainNode.connect(this.analyser)}ctx;analyser;dataArray;bufferLength;update(){this.analyser.getByteTimeDomainData(this.dataArray);const{width:t,height:e}=this.canvas;this.ctx.clearRect(0,0,t,e),this.ctx.lineWidth=2,this.ctx.strokeStyle="#8882",this.ctx.beginPath();const s=t/this.bufferLength;let i=0;for(let r=0;r<this.bufferLength;r++){const h=this.dataArray[r]/128*e/2;r===0?this.ctx.moveTo(i,h):this.ctx.lineTo(i,h),i+=s}this.ctx.lineTo(t,e/2),this.ctx.stroke()}drawFrequency(t,e,s,i,r){const n=this.analyser.frequencyBinCount,h=new Uint8Array(n);this.analyser.getByteFrequencyData(h);const c=a(e,s),p=Math.PI*2/n,{width:g,height:S}=this.canvas;this.ctx.clearRect(0,0,g,S),this.ctx.save(),this.ctx.strokeStyle=t,this.ctx.lineWidth=2;const A=16,d=1.5,y=(r-i)/d/A;for(let f=0;f<n;f++){const V=Math.floor(h[f]/(256/A)),b=f*p,w=a(1,0).rotated(b),E=a(1,0).rotated(b+p*3/4);for(let u=0;u<V;u++){const C=c.plus(w.scaled(i+y*u*d)),L=c.plus(w.scaled(i+y*(u*d+1))),M=c.plus(E.scaled(i+y*u*d)),k=c.plus(E.scaled(i+y*(u*d+1)));this.ctx.beginPath(),this.ctx.moveTo(C.x,C.y),this.ctx.lineTo(L.x,L.y),this.ctx.lineTo(k.x,k.y),this.ctx.lineTo(M.x,M.y),this.ctx.closePath(),this.ctx.stroke()}}this.ctx.restore()}}class I extends ${ready;#t=new q;#e=new _;mvUpdate=!0;constructor(t,e){super(),this.ready=this.#n(t,e)}async end(){this.mvUpdate=!1,this.#e.remove()}async#n(t,e){const s=await fetch("pages/game.html").then(i=>i.text());await this.#t.load(x.container,s),this.#i(t,e),this.#s(t,e),this.#a()}#i(t,e){this.#t.before("back",async()=>{const{SceneMap:s}=await o(async()=>{const{SceneMap:i}=await import("./SceneMap.js");return{SceneMap:i}},__vite__mapDeps([0,1,2]),import.meta.url);P.goto(()=>new s(t))}),this.#t.before("next",async()=>{const{SceneMap:s}=await o(async()=>{const{SceneMap:r}=await import("./SceneMap.js");return{SceneMap:r}},__vite__mapDeps([0,1,2]),import.meta.url);await P.goto(()=>new s(t));const i=await fetch("../../assets/stories/end.json").then(r=>r.json());D.say(...i[e])}),this.#t.before("retry",async()=>(this.#e.retry(),v.reset.play(),!0))}async#s(t,e){const s=this.#t.pages.get("first"),i=e>=13?e-13:e>=7?e-7:e,r=s.querySelector("#stage-id");r.textContent=`Stage: ${t}-${i}`;const n=s.querySelector("#center");n.appendChild(this.#e.svg),n.appendChild(this.#e.pen);const h=Object.assign({"../stages/Stage0.ts":()=>o(()=>import("./Stage0.js"),[],import.meta.url),"../stages/Stage1.ts":()=>o(()=>import("./Stage1.js"),[],import.meta.url),"../stages/Stage2.ts":()=>o(()=>import("./Stage2.js"),[],import.meta.url),"../stages/Stage3.ts":()=>o(()=>import("./Stage3.js"),[],import.meta.url),"../stages/Stage4.ts":()=>o(()=>import("./Stage4.js"),[],import.meta.url),"../stages/Stage5.ts":()=>o(()=>import("./Stage5.js"),[],import.meta.url),"../stages/Stage6.ts":()=>o(()=>import("./Stage6.js"),[],import.meta.url),"../stages/Stage7.ts":()=>o(()=>import("./Stage7.js"),[],import.meta.url),"../stages/Stage8.ts":()=>o(()=>import("./Stage8.js"),[],import.meta.url)}),c=`../stages/Stage${e}.ts`,{stage:p}=await h[c]();this.#e.render(p());const g=s.querySelector("#followed");this.#e.onClear=()=>{v.clear.play(),R.setStageData(e,{cleared:!0}),s.querySelector("[data-link=next]").classList.add("fade-in"),g.classList.remove("fade"),requestAnimationFrame(()=>{g.classList.add("fade")})},this.#e.onMove=()=>{v.move.play()}}#a(){const t=x.container.querySelector("canvas");t.width=x.container.clientWidth,t.height=x.container.clientHeight;const e=new O(t,T.wholeGain,T.context),s=()=>{e.drawFrequency("rgba(212, 209, 168, 0.07)",t.width/2,t.height/2,t.height/4,t.height),this.mvUpdate&&requestAnimationFrame(s)};requestAnimationFrame(s)}}export{I as SceneGame};
//# sourceMappingURL=SceneGame.js.map
