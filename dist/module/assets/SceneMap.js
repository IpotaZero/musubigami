const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SceneTitle.js","../run.js","./SceneGame.js"])))=>i.map(i=>d[i]);
import{_ as n,a as h,L as u,D as i,S as y,A as S}from"../run.js";import{S as _,P as g,B as w}from"./SceneTitle.js";const o={STAGE_OFFSETS:[0,7,13],UNLOCK_ARROW_TRIGGERS:{TO_CH1:6,TO_CH2:12},TUTORIAL_STAGES:[0,2,5,7],getGlobalStageId(c,t){return t+(this.STAGE_OFFSETS[c]||0)}};class f{constructor(t){this.container=t}moveYuyu(t){const e=this.container.querySelector("#yuyu");if(!e)return;const a=this.container.querySelectorAll(".stage")[t]?.getClientRects()[0];a&&(e.style.left=`${a.left-a.width/4}px`,e.style.top=`${a.top-a.height/4}px`)}renderArrows(t){t[o.UNLOCK_ARROW_TRIGGERS.TO_CH1]?.cleared&&this.container.querySelectorAll(".map-arrow-right")[0]?.classList.remove("hidden"),t[o.UNLOCK_ARROW_TRIGGERS.TO_CH2]?.cleared&&this.container.querySelectorAll(".map-arrow-right")[1]?.classList.remove("hidden")}renderChapter(t,e,a,s){const r=t.querySelector("svg"),d=r.querySelectorAll(".stage");d[0]?.classList.remove("hidden"),d.forEach((m,l)=>{const p=o.getGlobalStageId(e,l);a[p]?.cleared&&(this.#a(r,m),this.#e(r,l),this.#t(t,l)),m.onclick=()=>s(p)})}#a(t,e){if(e.dataset.hasStar)return;e.dataset.hasStar="true";const a=Number(e.getAttribute("x")),s=Number(e.getAttribute("y")),r=document.createElementNS("http://www.w3.org/2000/svg","image");r.setAttribute("href","assets/images/star.png"),r.setAttribute("x",String(a-12)),r.setAttribute("y",String(s-12)),r.setAttribute("width","24"),r.setAttribute("height","24"),r.classList.add("star-icon"),t.appendChild(r)}#e(t,e){t.querySelectorAll(`.path[data-from="${e}"], .path[data-to="${e}"]`).forEach(a=>a.classList.remove("hidden"))}#t(t,e){t.getConnectedVertices(e).forEach(a=>a.classList.remove("hidden"))}}class A{async playStageIntro(t){const e=await n(()=>import("./story.js"),[],import.meta.url);await h.say(...e.default[t].start)}async playTutorial(t){const e=o.TUTORIAL_STAGES.indexOf(t);if(e===-1)return;const a=await n(()=>import("./tutorial.js"),[],import.meta.url);await h.say(...a.default[e])}async playEvent(t,e){if(e&&u.getFlags().includes(e))return;const a=await n(()=>import("./event.js"),[],import.meta.url);await h.say(...a.default[t]),e&&u.addFlag(e)}}class O extends _{ready;#a=new g;#e;#t;#r;#l=0;constructor(t){super(),this.#r=t,this.#e=new f(i.container),this.#t=new A,this.ready=this.#s()}async#s(){await this.#a.loadFromFile(i.container,"assets/pages/map.html",{history:["ch"+this.#r]}),this.#a.on("ch[012]",e=>{const a=e.getCurrentPageId();this.#i(a)}),this.#a.before("back",async()=>{const{SceneTitle:e}=await n(async()=>{const{SceneTitle:a}=await import("./SceneTitle.js").then(s=>s.b);return{SceneTitle:a}},__vite__mapDeps([0,1]),import.meta.url);return y.goto(()=>new e),!0});const t=i.container.querySelectorAll("x-graph");await Promise.all(Array.from(t).map(e=>e.ready)),this.#n(),this.#h(),this.#e.moveYuyu(0)}#i(t){t==="ch1"&&this.#t.playEvent("敵対","ch1"),t==="ch2"&&this.#t.playEvent("歪み","ch2"),this.#r=parseInt(t.replace("ch","")),this.#e.moveYuyu(o.STAGE_OFFSETS[this.#r])}#n(){const t=u.getStageData();this.#e.renderArrows(t),i.container.querySelectorAll("x-graph").forEach((a,s)=>{this.#e.renderChapter(a,s,t,r=>this.#o(r))})}async#o(t){await this.#t.playStageIntro(t),await h.ask("やる?",["はい","いいえ"])===0&&await this.#c(t)}async#c(t){const{SceneGame:e}=await n(async()=>{const{SceneGame:a}=await import("./SceneGame.js").then(s=>s.S);return{SceneGame:a}},__vite__mapDeps([2,1,0]),import.meta.url);w.ffp("assets/sounds/bgm/why_was_faith_lost.mp3",{loop:!0,loopStartS:1.276}),await y.goto(()=>new e(this.#r,t),{fadeOut:S.valeOut,fadeIn:S.valeIn,msOut:850,msIn:850,afterLoad:()=>{this.#t.playTutorial(t)}})}#h(){i.container.querySelectorAll(".event").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.eventName;if(!e)throw new Error("イベント名が指定されていません");this.#t.playEvent(e)})})}}export{O as SceneMap};
//# sourceMappingURL=SceneMap.js.map
