const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SceneTitle.js","../run.js","./SceneGame.js"])))=>i.map(i=>d[i]);
import{_ as n,a as c,L as u,D as i,S as y,T as S,B as g}from"../run.js";import{S as _,P as f}from"./SceneTitle.js";const h={STAGE_OFFSETS:[0,7,13],UNLOCK_ARROW_TRIGGERS:{TO_CH1:6,TO_CH2:12},TUTORIAL_STAGES:[0,2,5,7,17],BOSSES:[6,12,16,17],getGlobalStageId(o,t){return t+(this.STAGE_OFFSETS[o]||0)}};class E{constructor(t){this.container=t}moveYuyu(t){const e=this.container.querySelector("#yuyu");if(!e)return;const a=this.container.querySelectorAll(".stage")[t]?.getClientRects()[0];a&&(e.style.left=`${a.left-a.width/4}px`,e.style.top=`${a.top-a.height/4}px`)}renderArrows(t){t[h.UNLOCK_ARROW_TRIGGERS.TO_CH1]?.cleared&&this.container.querySelectorAll(".map-arrow-right")[0]?.classList.remove("hidden"),t[h.UNLOCK_ARROW_TRIGGERS.TO_CH2]?.cleared&&this.container.querySelectorAll(".map-arrow-right")[1]?.classList.remove("hidden")}renderChapter(t,e,a,s){const r=t.querySelector("svg"),d=r.querySelectorAll(".stage");d[0]?.classList.remove("hidden"),d.forEach((m,l)=>{const p=h.getGlobalStageId(e,l);a[p]?.cleared&&(this.#a(r,m),this.#e(r,l),this.#t(t,l)),m.onclick=()=>s(p)})}#a(t,e){if(e.dataset.hasStar)return;e.dataset.hasStar="true";const a=Number(e.getAttribute("x")),s=Number(e.getAttribute("y")),r=document.createElementNS("http://www.w3.org/2000/svg","image");r.setAttribute("href","assets/images/star.png"),r.setAttribute("x",String(a-12)),r.setAttribute("y",String(s-12)),r.setAttribute("width","24"),r.setAttribute("height","24"),r.classList.add("star-icon"),t.appendChild(r)}#e(t,e){t.querySelectorAll(`.path[data-from="${e}"], .path[data-to="${e}"]`).forEach(a=>a.classList.remove("hidden"))}#t(t,e){t.getConnectedVertices(e).forEach(a=>a.classList.remove("hidden"))}}class w{async playStageIntro(t){const e=await n(()=>import("./story.js"),[],import.meta.url);await c.say(...e.default[t].start)}async playTutorial(t){const e=h.TUTORIAL_STAGES.indexOf(t);if(e===-1)return;const a=await n(()=>import("./tutorial.js"),[],import.meta.url);await c.say(...a.default[e])}async playEvent(t,e){if(e&&u.getFlags().includes(e))return;const a=await n(()=>import("./event.js"),[],import.meta.url);await c.say(...a.default[t]),e&&u.addFlag(e)}}class A extends _{ready;#a=new f;#e;#t;#r;#l=0;constructor(t){super(),this.#r=t,this.#e=new E(i.container),this.#t=new w,this.ready=this.#s()}async#s(){await this.#a.loadFromFile(i.container,"assets/pages/map.html",{history:["ch"+this.#r]}),this.#a.onEnter("ch[012]",e=>{const a=e.getCurrentPageId();this.#i(a)}),this.#a.beforeEnter("back",async()=>{y.goto(()=>n(async()=>{const{SceneTitle:e}=await import("./SceneTitle.js").then(a=>a.b);return{SceneTitle:e}},__vite__mapDeps([0,1]),import.meta.url).then(({SceneTitle:e})=>new e))});const t=i.container.querySelectorAll("x-graph");await Promise.all(Array.from(t).map(e=>e.ready)),this.#n(),this.#h(),this.#e.moveYuyu(0)}#i(t){t==="ch1"&&this.#t.playEvent("敵対","ch1"),t==="ch2"&&this.#t.playEvent("歪み","ch2"),this.#r=parseInt(t.replace("ch",""))}#n(){const t=u.getStageData();this.#e.renderArrows(t),i.container.querySelectorAll("x-graph").forEach((a,s)=>{this.#e.renderChapter(a,s,t,r=>this.#o(r))})}async#o(t){await this.#t.playStageIntro(t),await c.ask("",["やらない","やる"])===1&&await this.#c(t)}async#c(t){await y.goto(()=>n(async()=>{const{SceneGame:a}=await import("./SceneGame.js").then(s=>s.S);return{SceneGame:a}},__vite__mapDeps([2,1,0]),import.meta.url).then(({SceneGame:a})=>new a(this.#r,t)),{fadeOut:S.valeOut,fadeIn:S.valeIn,msOut:600,msIn:600,afterLoad:()=>{this.#t.playTutorial(t)}})}#h(){i.container.querySelectorAll(".event").forEach(t=>{t.addEventListener("click",async()=>{const e=t.dataset.eventName;if(!e)throw new Error("イベント名が指定されていません");const a=[];t.dataset.bgm&&a.push(g.glance(t.dataset.bgm)),a.push(this.#t.playEvent(e)),await Promise.all(a),t.dataset.bgm&&g.back()})})}}const R=Object.freeze(Object.defineProperty({__proto__:null,SceneMap:A},Symbol.toStringTag,{value:"Module"}));export{h as M,R as S};
//# sourceMappingURL=SceneMap.js.map
