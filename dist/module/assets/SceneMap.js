const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SceneTitle.js","../run.js","./SceneGame.js"])))=>i.map(i=>d[i]);
import{_ as c,a as h,L as S,D as n,S as y,B as o,A as g}from"../run.js";import{S as _,P as E}from"./SceneTitle.js";const s={STAGE_OFFSETS:[0,7,13],UNLOCK_ARROW_TRIGGERS:{TO_CH1:6,TO_CH2:12},TUTORIAL_STAGES:[0,2,5,7,17],BOSSES:[6,12,16,17],getGlobalStageId(l,t){return t+(this.STAGE_OFFSETS[l]||0)}};class w{constructor(t){this.container=t}moveYuyu(t){const e=this.container.querySelector("#yuyu");if(!e)return;const a=this.container.querySelectorAll(".stage")[t]?.getClientRects()[0];a&&(e.style.left=`${a.left-a.width/4}px`,e.style.top=`${a.top-a.height/4}px`)}renderArrows(t){t[s.UNLOCK_ARROW_TRIGGERS.TO_CH1]?.cleared&&this.container.querySelectorAll(".map-arrow-right")[0]?.classList.remove("hidden"),t[s.UNLOCK_ARROW_TRIGGERS.TO_CH2]?.cleared&&this.container.querySelectorAll(".map-arrow-right")[1]?.classList.remove("hidden")}renderChapter(t,e,a,i){const r=t.querySelector("svg"),d=r.querySelectorAll(".stage");d[0]?.classList.remove("hidden"),d.forEach((m,u)=>{const p=s.getGlobalStageId(e,u);a[p]?.cleared&&(this.#a(r,m),this.#e(r,u),this.#t(t,u)),m.onclick=()=>i(p)})}#a(t,e){if(e.dataset.hasStar)return;e.dataset.hasStar="true";const a=Number(e.getAttribute("x")),i=Number(e.getAttribute("y")),r=document.createElementNS("http://www.w3.org/2000/svg","image");r.setAttribute("href","assets/images/star.png"),r.setAttribute("x",String(a-12)),r.setAttribute("y",String(i-12)),r.setAttribute("width","24"),r.setAttribute("height","24"),r.classList.add("star-icon"),t.appendChild(r)}#e(t,e){t.querySelectorAll(`.path[data-from="${e}"], .path[data-to="${e}"]`).forEach(a=>a.classList.remove("hidden"))}#t(t,e){t.getConnectedVertices(e).forEach(a=>a.classList.remove("hidden"))}}class f{async playStageIntro(t){const e=await c(()=>import("./story.js"),[],import.meta.url);await h.say(...e.default[t].start)}async playTutorial(t){const e=s.TUTORIAL_STAGES.indexOf(t);if(e===-1)return;const a=await c(()=>import("./tutorial.js"),[],import.meta.url);await h.say(...a.default[e])}async playEvent(t,e){if(e&&S.getFlags().includes(e))return;const a=await c(()=>import("./event.js"),[],import.meta.url);await h.say(...a.default[t]),e&&S.addFlag(e)}}class A extends _{ready;#a=new E;#e;#t;#r;#u=0;constructor(t){super(),this.#r=t,this.#e=new w(n.container),this.#t=new f,this.ready=this.#s()}async#s(){await this.#a.loadFromFile(n.container,"assets/pages/map.html",{history:["ch"+this.#r]}),this.#a.on("ch[012]",e=>{const a=e.getCurrentPageId();this.#i(a)}),this.#a.before("back",async()=>{const{SceneTitle:e}=await c(async()=>{const{SceneTitle:a}=await import("./SceneTitle.js").then(i=>i.b);return{SceneTitle:a}},__vite__mapDeps([0,1]),import.meta.url);return y.goto(()=>new e),!0});const t=n.container.querySelectorAll("x-graph");await Promise.all(Array.from(t).map(e=>e.ready)),this.#o(),this.#h(),this.#e.moveYuyu(0),o.change("assets/sounds/bgm/仲介行脚.mp3",{loop:!0,loopEndS:118.125})}#i(t){t==="ch1"&&this.#t.playEvent("敵対","ch1"),t==="ch2"&&this.#t.playEvent("歪み","ch2"),this.#r=parseInt(t.replace("ch","")),this.#e.moveYuyu(s.STAGE_OFFSETS[this.#r])}#o(){const t=S.getStageData();this.#e.renderArrows(t),n.container.querySelectorAll("x-graph").forEach((a,i)=>{this.#e.renderChapter(a,i,t,r=>this.#n(r))})}async#n(t){await this.#t.playStageIntro(t),await h.ask("",["やらない","やる"])===1&&await this.#c(t)}async#c(t){const{SceneGame:e}=await c(async()=>{const{SceneGame:i}=await import("./SceneGame.js").then(r=>r.S);return{SceneGame:i}},__vite__mapDeps([2,1,0]),import.meta.url);this.#l(t);const a=s.BOSSES.includes(t)?1300:850;await y.goto(()=>new e(this.#r,t),{fadeOut:g.valeOut,fadeIn:g.valeIn,msOut:a,msIn:a,afterLoad:()=>{this.#t.playTutorial(t)}})}async#l(t){t===s.BOSSES[0]||t===s.BOSSES[1]||t===s.BOSSES[2]?await o.change("assets/sounds/bgm/まるでパズル感覚で.mp3",{loop:!0,loopStartS:11.111,loopEndS:82.222,volume:.8}):t===s.BOSSES[3]?await o.change("assets/sounds/bgm/block.mp3",{loop:!0,loopStartS:13.333,loopEndS:95,volume:.5}):await o.change("assets/sounds/bgm/why_was_faith_lost.mp3",{loop:!0,loopStartS:1.276})}#h(){n.container.querySelectorAll(".event").forEach(t=>{t.addEventListener("click",async()=>{const e=t.dataset.eventName;if(!e)throw new Error("イベント名が指定されていません");t.dataset.bgm&&o.glance(t.dataset.bgm),await this.#t.playEvent(e),t.dataset.bgm&&o.back()})})}}const b=Object.freeze(Object.defineProperty({__proto__:null,SceneMap:A},Symbol.toStringTag,{value:"Module"}));export{s as M,b as S};
//# sourceMappingURL=SceneMap.js.map
