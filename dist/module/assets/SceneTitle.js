const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SceneMap.js","../run.js"])))=>i.map(i=>d[i]);
import{T as E,A as d,D as f,B as c,L as i,S as p,_ as w,a as P}from"../run.js";class l{#t;#e;constructor(t,e=.5){this.#t=new Audio(t),this.#e=e,this.#t.volume=e,this.#t.preload="auto"}get duration(){return this.#t.duration}play(){this.#t.currentTime=0,this.#t.play()}setVolume(t){this.#t.volume=t*this.#e}}class u{static clear=new l("assets/sounds/se/clear.mp3",1);static move=new l("assets/sounds/se/マウススプレー・口内.mp3",.5);static reset=new l("assets/sounds/se/窓を開ける.mp3",1);static switch=new l("assets/sounds/se/引き戸を閉める.mp3",1);static click=new l("assets/sounds/se/カーソル移動2.mp3",1);static suzu=new l("assets/sounds/se/鈴が鳴る.mp3",1);static kansei=new l("assets/sounds/se/歓声.mp3",1);static setVolume(t){Object.values(this).forEach(e=>{e.setVolume(t)})}}class g{#t;constructor(t={}){this.#t=t}get(t){for(const[e,s]of Object.entries(this.#t))if(new RegExp(`^${e}$`).test(t))return s}*getAll(t){for(const[e,s]of Object.entries(this.#t))new RegExp(`^${e}$`).test(t)&&(yield s)}getKeys(){return Object.keys(this.#t)}getValues(){return Object.values(this.#t)}add(t,e){this.#t[t]=e}}class b{container;pages=new g({});ready;constructor(t,e){this.container=t,this.ready=this.setup(e)}async fadeOut(t,{msOut:e}={}){const s=this.getPage(t);await E.fadeOut(this.container,e),s.classList.add("hidden")}async fadeIn(t,{msIn:e}={}){this.getPage(t).classList.remove("hidden"),await E.fadeIn(this.container,e)}getPage(t,e={}){const s=this.pages.get(t);if(e.noError)return s;if(!s)throw new Error("存在しないページを得ようとした。");return s}getAllPages(t){return this.pages.getAll(t)}async setup(t){this.container.style.display="none",this.container.innerHTML=t,Array.from(this.container.querySelectorAll(".page")).filter(s=>s instanceof HTMLElement).forEach(s=>{this.pages.add(s.id,s),s.classList.add("hidden")});const e=Promise.all([d.waitCSSLoad(this.container),d.waitElementReady(this.container)]);await d.timeOver(5e3,e,()=>{console.warn("pageの読み込みに時間掛かり過ぎ! スキップしました。")}),this.container.style.display=""}}class S{static DEFAULT_IN_MS=250;static DEFAULT_OUT_MS=250;static setOnclick(t,{enter:e,back:s}){t.querySelectorAll("[data-link]").forEach(a=>{const r=a.dataset.link||"first",o=h(a.dataset.msIn,this.DEFAULT_IN_MS),m=h(a.dataset.msOut,this.DEFAULT_OUT_MS);a.onclick=()=>e(r,{msIn:o,msOut:m})}),t.querySelectorAll("[data-back]").forEach(a=>{const r=h(a.dataset.back,1),o=h(a.dataset.msIn,this.DEFAULT_IN_MS),m=h(a.dataset.msOut,this.DEFAULT_OUT_MS);a.onclick=()=>s(r,{msIn:o,msOut:m})})}}class _{onEnterHandlers=new g;onLeftHandlers=new g;beforeEnterHandlers=new g;setOnEnter(t,e){this.onEnterHandlers.add(t,e)}setOnLeft(t,e){this.onLeftHandlers.add(t,e)}setBeforeEnter(t,e){this.beforeEnterHandlers.add(t,e)}onEnter(t,e){return Promise.all(this.onEnterHandlers.getAll(e).map(s=>s(t)))}onLeft(t,e){return Promise.all(this.onLeftHandlers.getAll(e).map(s=>s(t)))}async beforeEnter(t,e){const s=Array.from(this.beforeEnterHandlers.getAll(e).map(o=>o(t)));return s.length===0?!0:(await Promise.all(s)).every(Boolean)}}class O{currentPageId="first";history=[];transitioning=!1;constructor(t){const e=t&&t.length?t.at(-1):"first";this.history=t&&t.length?t.slice(0,-1):[],this.currentPageId=e}goto(t){this.history.push(t),this.currentPageId=t}back(t){if(!Number.isInteger(t)||t<=0)throw new Error("depth must be an integer (>= 1).");if(this.history.length<=t)return this.history=[],"first";for(let e=0;e<t;e++)this.history.pop();return this.history.pop()}isTransitioning(){return this.transitioning}startTransition(){if(this.transitioning)throw new Error("Pages向けのError: 状態移行中に別の移行を始めようとした。");this.transitioning=!0}endTransition(){if(!this.transitioning)throw new Error("Pages向けのError: 状態移行中じゃあないのに状態変化を終わらせようとした。");this.transitioning=!1}}class T{dom;state;run=new _;onEnter=this.run.setOnEnter.bind(this.run);onLeft=this.run.setOnLeft.bind(this.run);beforeEnter=this.run.setBeforeEnter.bind(this.run);async loadFromFile(t,e,s={}){const a=await fetch(e).then(r=>r.text());await this.load(t,a,s)}async load(t,e,{history:s}={}){if(this.dom)throw new Error("Pages have already been loaded");this.dom=new b(t,e),await this.dom.ready,S.setOnclick(this.dom.container,{enter:this.enter.bind(this),back:this.back.bind(this)}),this.state=new O(s),await this.goto(this.state.currentPageId,{msIn:0,msOut:0})}getPage(t,e={}){return e.noError?this.dom.getPage(t,{noError:!0}):this.dom.getPage(t)}getAllPages(t){return this.dom.getAllPages(t)}getCurrentPage(){return this.dom.getPage(this.state.currentPageId)}getCurrentPageId(){return this.state.currentPageId}async back(t,e={}){await this.goto(this.state.back(t),Object.assign(e,{back:!0}))}async enter(t,e={}){await this.goto(t,Object.assign(e,{back:!1}))}async goto(t,e){if(this.state.isTransitioning())return;if(this.state.startTransition(),!await this.run.beforeEnter(this,t)){this.state.endTransition();return}const a=h(this.dom.getPage(this.state.currentPageId).dataset.layer,0),r=h(this.dom.getPage(t).dataset.layer,0);await this.transition(a,r,t,e),this.state.endTransition()}async transition(t,e,s,{msIn:a,msOut:r,back:o}){if(t===e)await this.dom.fadeOut(this.state.currentPageId,{msOut:r}),await this.run.onLeft(this,this.state.currentPageId),this.state.goto(s),await this.run.onEnter(this,s),await this.dom.fadeIn(s,{msIn:a});else if(t<e)this.state.goto(s),await this.run.onEnter(this,s),await this.dom.fadeIn(s,{msIn:a});else{if(!o)throw new Error("下のlayerにback以外でgotoしようとした。");await this.dom.fadeOut(this.state.currentPageId,{msOut:r}),await this.run.onLeft(this,this.state.currentPageId),this.state.goto(s)}}}function h(n,t){return!n||Number.isNaN(Number(n))?t:Number(n)}class L{async end(){}}class y extends L{ready;#t=new T;constructor(){super(),this.ready=this.#e()}async#e(){await this.#t.loadFromFile(f.container,"assets/pages/title.html"),this.#n(),this.#i(),this.#r(),this.#s(),this.#c()}#s(){this.#t.beforeEnter("start",async t=>{u.suzu.play(),c.pause(),c.unload("assets/sounds/bgm/信仰の残り香.mp3"),c.change("assets/sounds/bgm/仲介行脚.mp3",{loop:!0,loopEndS:118.125}),i.getFlags().includes("始まり")?await p.goto(()=>w(async()=>{const{SceneMap:e}=await import("./SceneMap.js").then(s=>s.S);return{SceneMap:e}},__vite__mapDeps([0,1]),import.meta.url).then(({SceneMap:e})=>new e(0))):await p.goto(()=>w(async()=>{const{SceneMap:e}=await import("./SceneMap.js").then(s=>s.S);return{SceneMap:e}},__vite__mapDeps([0,1]),import.meta.url).then(({SceneMap:e})=>new e(0)),{msIn:1800,msOut:1800,afterLoad:async()=>{this.#a()}})}),this.#t.beforeEnter("delete-data",async()=>{await P.ask("ほんとに?",["はい","いいえ"])===0&&(i.clear(),p.goto(async()=>new y))}),this.#t.beforeEnter("fullscreen",t=>{document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()})}async#a(){i.addFlag("始まり");const t=await w(()=>import("./event.js"),[],import.meta.url);await P.say(...t.default.始まり)}#n(){const t=this.#t.getPage("first");c.fadeOut(),d.ok().then(()=>{t.classList.add("show"),c.change("assets/sounds/bgm/信仰の残り香.mp3"),this.#o()})}#i(){const t=this.#t.getPage("setting"),e=t.querySelector("#bgm-volume"),s=t.querySelector("#se-volume");e.value=String(i.getBGMVolume()),s.value=String(i.getSEVolume()),c.setVolume(i.getBGMVolume()/9),u.setVolume(i.getSEVolume()/9),e.oninput=()=>{i.setBGMVolume(+e.value),c.setVolume(i.getBGMVolume()/9)},s.oninput=()=>{i.setSEVolume(+s.value),u.setVolume(i.getSEVolume()/9),u.move.play()}}#r(){}#o(){const t=f.container;for(let e=0;e<30;e++){const s=document.createElement("div");s.classList.add("particle"),s.style.left=`${Math.random()*100}%`,s.style.width=`${20+Math.random()*30}px`,s.style.height=s.style.width,s.style.animationDuration=`${5+Math.random()*5}s`,s.style.animationDelay=`${Math.random()*10}s`,t.appendChild(s)}}#c(){i.getStageData().every(t=>t.cleared)&&f.container.querySelector("[data-link=story]")?.classList.remove("hidden")}}const I=Object.freeze(Object.defineProperty({__proto__:null,SceneTitle:y},Symbol.toStringTag,{value:"Module"}));export{T as P,L as S,u as a,I as b};
//# sourceMappingURL=SceneTitle.js.map
