const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./SceneMap.js","../run.js"])))=>i.map(i=>d[i]);
import{A as f,D as y,_ as S,S as p,L as i,a as w}from"../run.js";class d{#t;#e;constructor(t,e=.5){this.#t=new Audio(t),this.#e=e,this.#t.volume=e}get duration(){return this.#t.duration}play(){this.#t.currentTime=0,this.#t.play()}setVolume(t){this.#t.volume=t*this.#e}}class m{static clear=new d("assets/sounds/se/clear.mp3",1);static move=new d("assets/sounds/se/マウススプレー・口内.mp3",.5);static reset=new d("assets/sounds/se/窓を開ける.mp3",1);static setVolume(t){Object.values(this).forEach(e=>{e.setVolume(t)})}}class n{static context=new AudioContext;static wholeGain=this.context.createGain();static#t=1;static#e=null;static{this.wholeGain.connect(this.context.destination)}#n;#a;#o=1;#r;#s=null;#i=!1;constructor(t,e){this.#n=t,this.#o=e.volume??1,this.#a=n.context.createGain(),this.#a.gain.value=this.#o,this.#a.connect(n.wholeGain),this.#r=this.#c(e)}async#c(t){const s=await(await fetch(this.#n)).arrayBuffer(),a=await n.context.decodeAudioData(s);this.#s=n.context.createBufferSource(),this.#s.buffer=a,this.#s.loopStart=t.loopStartS??0,this.#s.loopEnd=t.loopEndS??a.duration,this.#s.loop=t.loop??!0,this.#s.connect(this.#a)}async#h(t){this.#a.gain.setValueAtTime(this.#o,n.context.currentTime),this.#a.gain.linearRampToValueAtTime(0,n.context.currentTime+t/1e3),await new Promise(e=>setTimeout(e,t)),this.#a.disconnect(),this.#i&&this.#s?.stop(),this.#s?.disconnect()}static getPath(){return this.#e?this.#e.#n:""}static async ffp(t,e={}){await Promise.all([this.#m(1e3),this.#u(t,e)]),this.getPath()===t&&this.#d(e.when??0)}static async#u(t,e){this.#e=new n(t,e),await this.#e.#r}static#d(t){this.#e&&(this.#e.#s?.start(this.context.currentTime+t),this.#e.#i=!0)}static setVolume(t){this.#t=t,this.wholeGain.gain.value=this.#t}static async#m(t){this.#e&&await this.#e.#h(t)}}window.BGM=n;class l{#t;constructor(t){this.#t=t}get(t){for(const[e,s]of Object.entries(this.#t))if(new RegExp(`^${e}$`).test(t))return s}*getAll(t){for(const[e,s]of Object.entries(this.#t))new RegExp(`^${e}$`).test(t)&&(yield s)}getKeys(){return Object.keys(this.#t)}getValues(){return Object.values(this.#t)}add(t,e){this.#t[t]=e}}class o{static#t=250;static#e=250;pages=new l({});#n=new l({});#a=new l({});#o=new l({});#r;#s=[];#i="first";#c=!1;async load(t,e,{history:s}={}){if(this.#c)throw new Error("Pages have already been loaded");this.#c=!0,this.#r=t,this.#r.innerHTML=e;const a=s&&s.length?s.at(-1):"first";this.#s=s&&s.length?s.slice(0,-1):[],t.querySelectorAll(".page").forEach(c=>{this.pages.add(c.id,c),c.classList.add("hidden")}),await this.goto(a,{msIn:0,msOut:0}),this.setupButtonsOnclick()}getCurrentPage(){return this.pages.get(this.#i)}getCurrentPageId(){return this.#i}on(t,e){this.#n.add(t,e)}onLeft(t,e){this.#a.add(t,e)}before(t,e){this.#o.add(t,e)}setupButtonsOnclick(){this.#r.querySelectorAll("[data-back]").forEach(this.#h.bind(this)),this.#r.querySelectorAll("[data-link]").forEach(this.#u.bind(this))}#h(t){const e=Number(t.dataset.back)||1,s=h(t.dataset["ms-in"],o.#t),a=h(t.dataset["ms-Out"],o.#e);t.onclick=async()=>{this.#l(!1),await this.back(e,{msIn:s,msOut:a}),this.#l(!0)}}#u(t){const e=t.dataset.link||"first",s=h(t.dataset["ms-in"],o.#t),a=h(t.dataset["ms-Out"],o.#e);t.onclick=async()=>{this.#l(!1),await this.goto(e,{msIn:s,msOut:a}),this.#l(!0)}}async back(t,e={}){for(let s=0;s<t;s++)await this.#d(e)}async#d(t={}){this.#s.length!==0&&(this.#s.pop(),await this.goto(this.#s.pop(),t))}async goto(t,{msIn:e=o.#t,msOut:s=o.#e}={}){if(await this.#m(t))return;this.#f(this.#i);const c=this.pages.get(this.#i),u=this.pages.get(t);c&&(await f.fadeOut(c,s),c.classList.add("hidden")),this.#s.push(t),this.#i=t,this.#g(this.#i),u&&(u.classList.remove("hidden"),await f.fadeIn(u,e))}async#m(t){const e=this.#o.getAll(t).map(a=>a(this));return(await Promise.all(e)).some(Boolean)}#f(t){this.#a.getAll(t).map(e=>e(this))}#g(t){requestAnimationFrame(()=>{this.#n.getAll(t).forEach(e=>e(this))})}#l(t){const e=this.getCurrentPage();e&&e.querySelectorAll("[data-link], [data-back]").forEach(s=>{s.style.pointerEvents=t?"":"none"})}}function h(r,t){return!r||Number.isNaN(Number(r))?t:Number(r)}class b{async end(){}}class g extends b{ready;#t=new o;constructor(){super(),this.ready=this.#e()}async#e(){const t=await fetch("assets/pages/title.html").then(e=>e.text());await this.#t.load(y.container,t),this.#a(),this.#o(),this.#t.before("start",async e=>{const{SceneMap:s}=await S(async()=>{const{SceneMap:a}=await import("./SceneMap.js");return{SceneMap:a}},__vite__mapDeps([0,1]),import.meta.url);return await p.goto(()=>new s(0)),i.getFlags().includes("始まり")||this.#n(),!0}),this.#t.before("delete-data",async()=>(await w.ask("ほんとに?",["はい","いいえ"])===0&&(i.clear(),p.goto(()=>new g)),!0)),this.#t.before("fullscreen",async e=>(document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen(),!0))}async#n(){i.addFlag("始まり");const t=await fetch("../../assets/stories/始まり.json").then(e=>e.json());await w.say(...t)}#a(){const t=this.#t.pages.get("first");f.ok().then(()=>{t.classList.add("show")})}#o(){const t=this.#t.pages.get("setting"),e=t.querySelector("#bgm-volume"),s=t.querySelector("#se-volume");e.value=String(i.getBGMVolume()),s.value=String(i.getSEVolume()),n.setVolume(i.getBGMVolume()/9),m.setVolume(i.getSEVolume()/9),e.oninput=()=>{i.setBGMVolume(+e.value),n.setVolume(i.getBGMVolume()/9)},s.oninput=()=>{i.setSEVolume(+s.value),m.setVolume(i.getSEVolume()/9),m.move.play()}}}const V=Object.freeze(Object.defineProperty({__proto__:null,SceneTitle:g},Symbol.toStringTag,{value:"Module"}));export{n as B,o as P,b as S,m as a,V as b};
//# sourceMappingURL=SceneTitle.js.map
