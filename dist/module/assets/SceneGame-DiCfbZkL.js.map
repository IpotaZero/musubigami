{"version":3,"mappings":"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","names":["SVG_NS","Game","#penIndex","#vertexElements","#edgeElements","#edges","#leftEdges","#abortController","#firstClicked","width","height","edgesGroup","vertsGroup","#createMarker","#updatePenPosition","vertices","edges","e","a","b","edge","#createEdge","v","vertex","#createVertex","index","#onClickVertex","#updateGraphics","#updateEdgeColor","#updateVertexColor","edgeIndex","i","n","rect","isConnected","line","svg","marker","path","SceneGame","Scene","#pages","Pages","#game","ch","stageId","#setup","html","res","Dom","#setupButtons","#setupGame","SceneMap","__vitePreload","SceneChanger","commands","Serif","container","stageLabel","center","modules","url","stage","followed","LocalStorage"],"ignoreList":[],"sources":["../../../src/Game.ts","../../../src/Scenes/SceneGame.ts"],"sourcesContent":["export type Vertex = [x: number, y: number]\r\nexport type Edge = [from: number, to: number, multiplicity?: number, arrow?: boolean]\r\n\r\nconst SVG_NS = \"http://www.w3.org/2000/svg\"\r\n\r\nexport class Game {\r\n    onClear = () => {}\r\n\r\n    readonly svg: SVGSVGElement\r\n\r\n    readonly pen = document.createElement(\"span\")\r\n    #penIndex: number = 0\r\n\r\n    #vertexElements: SVGRectElement[] = []\r\n    #edgeElements: SVGPolylineElement[] = []\r\n\r\n    #edges: Edge[] = []\r\n    #leftEdges: number[] = []\r\n\r\n    #abortController = new AbortController()\r\n\r\n    #firstClicked = false\r\n\r\n    constructor(width = 400, height = 300) {\r\n        // create SVG\r\n        this.svg = document.createElementNS(SVG_NS, \"svg\")\r\n        // this.svg.setAttribute(\"width\", String(width))\r\n        // this.svg.setAttribute(\"height\", String(height))\r\n        this.svg.setAttribute(\"viewBox\", `${-width / 2} ${-height / 2} ${width} ${height}`)\r\n        this.svg.style.display = \"block\"\r\n        this.svg.classList.add(\"game-svg\")\r\n\r\n        // groups for ordering: edges under vertices\r\n        const edgesGroup = document.createElementNS(SVG_NS, \"g\")\r\n        edgesGroup.setAttribute(\"class\", \"edges\")\r\n        this.svg.appendChild(edgesGroup)\r\n\r\n        const vertsGroup = document.createElementNS(SVG_NS, \"g\")\r\n        vertsGroup.setAttribute(\"class\", \"vertices\")\r\n        this.svg.appendChild(vertsGroup)\r\n\r\n        this.pen.classList.add(\"game-pen\")\r\n\r\n        this.svg.appendChild(Game.#createMarker(this.svg))\r\n\r\n        window.addEventListener(\r\n            \"resize\",\r\n            () => {\r\n                this.#updatePenPosition()\r\n            },\r\n            { signal: this.#abortController.signal },\r\n        )\r\n    }\r\n\r\n    remove() {\r\n        this.#abortController.abort()\r\n    }\r\n\r\n    // simple renderer: clear groups and recreate elements\r\n    render({ vertices, edges }: { vertices: Vertex[]; edges: Edge[] }) {\r\n        this.#edges = edges\r\n\r\n        // remove existing children of groups\r\n        const edgesGroup = this.svg.querySelector(\"g.edges\")!\r\n        const vertsGroup = this.svg.querySelector(\"g.vertices\")!\r\n        while (edgesGroup.firstChild) edgesGroup.removeChild(edgesGroup.firstChild)\r\n        while (vertsGroup.firstChild) vertsGroup.removeChild(vertsGroup.firstChild)\r\n\r\n        // draw edges (lines)\r\n        for (const e of edges) {\r\n            const a = vertices[e[0]]\r\n            const b = vertices[e[1]]\r\n            if (!a || !b) continue\r\n\r\n            const edge = this.#createEdge(a, b, e)\r\n            edgesGroup.appendChild(edge)\r\n            this.#edgeElements.push(edge)\r\n        }\r\n\r\n        // draw vertices (circles)\r\n        for (const v of vertices) {\r\n            const vertex = this.#createVertex(v)\r\n            vertsGroup.appendChild(vertex)\r\n            this.#vertexElements.push(vertex)\r\n        }\r\n\r\n        this.#vertexElements.forEach((vertex, index) => {\r\n            vertex.addEventListener(\"click\", () => {\r\n                this.#onClickVertex(index)\r\n            })\r\n        })\r\n\r\n        this.#leftEdges = edges.map((e) => e[2] ?? 1)\r\n\r\n        this.#updateGraphics()\r\n    }\r\n\r\n    retry() {\r\n        this.#firstClicked = false\r\n        this.#penIndex = 0\r\n        this.#leftEdges = this.#edges.map((e) => e[2] ?? 1)\r\n        this.#updateGraphics()\r\n    }\r\n\r\n    #updateGraphics() {\r\n        this.#updateEdgeColor()\r\n        this.#updatePenPosition()\r\n        this.#updateVertexColor()\r\n    }\r\n\r\n    #onClickVertex(index: number) {\r\n        if (!this.#firstClicked) {\r\n            this.#penIndex = index\r\n            this.#firstClicked = true\r\n            this.#updateGraphics()\r\n            return\r\n        }\r\n\r\n        if (index === this.#penIndex) return\r\n\r\n        // 現在の頂点とクリックした頂点を結ぶ辺が残っているか\r\n        const edgeIndex = this.#edges.findIndex((e, i) => {\r\n            // 通られているか?\r\n            if (this.#leftEdges[i] === 0) return false\r\n\r\n            // 一方通行の場合\r\n            if (e[3]) {\r\n                return e[1] === this.#penIndex && e[0] === index\r\n            }\r\n\r\n            return (e[0] === this.#penIndex && e[1] === index) || (e[1] === this.#penIndex && e[0] === index)\r\n        })\r\n\r\n        if (edgeIndex === -1) return\r\n\r\n        // 辺の残数を減らす\r\n        this.#leftEdges[edgeIndex]--\r\n\r\n        // ペンを移動\r\n        this.#penIndex = index\r\n\r\n        this.#updateGraphics()\r\n\r\n        if (this.#leftEdges.every((n) => n === 0)) {\r\n            this.onClear()\r\n        }\r\n    }\r\n\r\n    #updatePenPosition() {\r\n        if (!this.#firstClicked) {\r\n            this.pen.style.left = `calc(100% - 13dvh)`\r\n            this.pen.style.top = `calc(100% - 13dvh)`\r\n            return\r\n        }\r\n\r\n        const penVertex = this.#vertexElements[this.#penIndex]\r\n        const rect = penVertex.getBoundingClientRect()\r\n        this.pen.style.left = `${rect.x + rect.width / 2}px`\r\n        this.pen.style.top = `${rect.y + rect.height / 2}px`\r\n    }\r\n\r\n    #updateVertexColor() {\r\n        if (!this.#firstClicked) {\r\n            this.#vertexElements.forEach((rect) => (rect.dataset.active = \"true\"))\r\n            return\r\n        }\r\n\r\n        this.#vertexElements.forEach((rect, index) => {\r\n            const isConnected = this.#edges.some((e, i) => {\r\n                if (index === this.#penIndex) return false\r\n                if (this.#leftEdges[i] === 0) return false\r\n\r\n                if (e[3]) {\r\n                    return e[1] === this.#penIndex && e[0] === index\r\n                }\r\n\r\n                return (e[0] === this.#penIndex && e[1] === index) || (e[1] === this.#penIndex && e[0] === index)\r\n            })\r\n\r\n            rect.dataset.active = String(isConnected)\r\n\r\n            rect.dataset.current = String(index === this.#penIndex)\r\n        })\r\n    }\r\n\r\n    #updateEdgeColor() {\r\n        this.#edgeElements.forEach((line, index) => {\r\n            line.dataset.left = String(this.#leftEdges[index])\r\n        })\r\n    }\r\n\r\n    #createEdge(a: Vertex, b: Vertex, e: Edge) {\r\n        const line = document.createElementNS(SVG_NS, \"polyline\")\r\n\r\n        line.setAttribute(\"points\", `${a[0]},${a[1]} ${(a[0] + b[0]) / 2},${(a[1] + b[1]) / 2} ${b[0]},${b[1]}`)\r\n        line.setAttribute(\"stroke\", \"currentColor\")\r\n        line.setAttribute(\"stroke-width\", \"3\")\r\n        line.setAttribute(\"stroke-linecap\", \"round\")\r\n        line.setAttribute(\"data-from\", String(e[0]))\r\n        line.setAttribute(\"data-to\", String(e[1]))\r\n        line.classList.add(\"edge\")\r\n\r\n        if (e[3]) {\r\n            line.setAttribute(\"marker-mid\", \"url(#arrow-end)\")\r\n        }\r\n\r\n        return line\r\n    }\r\n\r\n    #createVertex(v: Vertex) {\r\n        const size = 48 // 正方形の一辺\r\n        const rect = document.createElementNS(SVG_NS, \"rect\")\r\n        rect.setAttribute(\"width\", String(size))\r\n        rect.setAttribute(\"height\", String(size))\r\n        rect.setAttribute(\"x\", String(v[0] - size / 2))\r\n        rect.setAttribute(\"y\", String(v[1] - size / 2))\r\n        rect.setAttribute(\"fill\", \"#f5f5f5\")\r\n        rect.setAttribute(\"stroke\", \"#111\")\r\n        rect.setAttribute(\"stroke-width\", \"0.5\")\r\n        rect.classList.add(\"vertex\")\r\n\r\n        return rect\r\n    }\r\n\r\n    static #createMarker(svg: SVGSVGElement) {\r\n        const marker = document.createElementNS(svg.namespaceURI, \"marker\")\r\n\r\n        marker.id = \"arrow-end\"\r\n        marker.setAttribute(\"orient\", \"auto\")\r\n        marker.setAttribute(\"markerWidth\", \"4\")\r\n        marker.setAttribute(\"markerHeight\", \"4\")\r\n        marker.setAttribute(\"refX\", \"8\")\r\n        marker.setAttribute(\"refY\", \"2\")\r\n\r\n        const path = document.createElementNS(svg.namespaceURI, \"path\")\r\n        path.setAttribute(\r\n            \"d\",\r\n            `M 4 0\r\n             Q 2 1.3, 0 2\r\n             Q 2 2.7, 4 4\r\n             Z`,\r\n        )\r\n        path.setAttribute(\"fill\", \"currentColor\")\r\n        marker.appendChild(path)\r\n\r\n        return marker\r\n    }\r\n}\r\n","import { Dom } from \"../Dom\"\r\nimport { Edge, Game, Vertex } from \"../Game\"\r\nimport { LocalStorage } from \"../LocalStorage\"\r\nimport { Pages } from \"../utils/Pages\"\r\nimport { Serif, SerifCommand } from \"../utils/Serif\"\r\nimport { Scene } from \"./Scene\"\r\nimport { SceneChanger } from \"./SceneChanger\"\r\n\r\ntype Chapters = 0 | 1 | 2\r\n\r\nexport class SceneGame extends Scene {\r\n    readonly ready: Promise<void>\r\n    readonly #pages = new Pages()\r\n    readonly #game = new Game()\r\n\r\n    constructor(ch: Chapters, stageId: number) {\r\n        super()\r\n        this.ready = this.#setup(ch, stageId)\r\n    }\r\n\r\n    override async end(): Promise<void> {\r\n        this.#game.remove()\r\n    }\r\n\r\n    async #setup(ch: Chapters, stageId: number) {\r\n        const html = await fetch(\"pages/game.html\").then((res) => res.text())\r\n        await this.#pages.load(Dom.container, html)\r\n\r\n        this.#setupButtons(ch, stageId)\r\n        this.#setupGame(ch, stageId)\r\n    }\r\n\r\n    #setupButtons(ch: Chapters, stageId: number) {\r\n        this.#pages.before(\"back\", async () => {\r\n            const { SceneMap } = await import(\"./SceneMap\")\r\n            SceneChanger.goto(() => new SceneMap(ch))\r\n        })\r\n\r\n        this.#pages.before(\"next\", async () => {\r\n            const { SceneMap } = await import(\"./SceneMap\")\r\n            await SceneChanger.goto(() => new SceneMap(ch))\r\n\r\n            const commands = await fetch(`../../assets/stories/end${stageId}.json`).then((res) => res.json())\r\n            Serif.say(...commands)\r\n        })\r\n\r\n        this.#pages.before(\"retry\", async () => {\r\n            this.#game.retry()\r\n            return true\r\n        })\r\n    }\r\n\r\n    async #setupGame(ch: Chapters, stageId: number) {\r\n        const container = this.#pages.pages.get(\"first\")!\r\n\r\n        const stageLabel = container.querySelector(\"#stage-id\")!\r\n        stageLabel.textContent = `Stage: ${ch}-${stageId}`\r\n\r\n        const center = container.querySelector(\"#center\")!\r\n        center.appendChild(this.#game.svg)\r\n        center.appendChild(this.#game.pen)\r\n\r\n        // @ts-ignore\r\n        const modules = import.meta.glob(\"../stages/*\")\r\n        const url = `../stages/Stage${stageId}.ts`\r\n        const { stage } = await modules[url]()\r\n\r\n        this.#game.render(stage())\r\n\r\n        const followed = container.querySelector(\"#followed\")\r\n\r\n        this.#game.onClear = () => {\r\n            LocalStorage.setStageData(stageId, { cleared: true })\r\n            const nextButton = container.querySelector(\"[data-link=next]\")!\r\n            nextButton.classList.add(\"fade-in\")\r\n            followed?.classList.add(\"fade\")\r\n        }\r\n    }\r\n}\r\n"],"file":"SceneGame-DiCfbZkL.js"}