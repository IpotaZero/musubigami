{"version":3,"mappings":"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","names":["SceneMap","Scene","#pages","Pages","#currentCh","ch","#setup","html","res","Dom","pages","#initializeMapState","#setupBackButton","stageData","LocalStorage","MapConfig","MapGraphView","graph","chapterIndex","svg","stageButtons","button","localStageIndex","globalStageId","#onStageClick","SceneTitle","__vitePreload","n","SceneChanger","stageId","Z","commands","Serif","#transitionToGame","#playTutorial","SceneGame","Awaits","index","rect","x","y","img","edge","stage","container","arrowIndex"],"ignoreList":[],"sources":["../../../src/Scenes/SceneMap.ts"],"sourcesContent":["// SceneMap.ts\r\nimport { Dom } from \"../Dom\"\r\nimport { LocalStorage } from \"../LocalStorage\"\r\nimport { Awaits } from \"../utils/Awaits\"\r\nimport { Graph } from \"../utils/Graph\"\r\nimport { Pages } from \"../utils/Pages\"\r\nimport { Serif } from \"../utils/Serif\"\r\nimport { Scene } from \"./Scene\"\r\nimport { SceneChanger } from \"./SceneChanger\"\r\n\r\nexport class SceneMap extends Scene {\r\n    readonly ready: Promise<void>\r\n    readonly #pages = new Pages()\r\n    #currentCh: 0 | 1 | 2\r\n\r\n    constructor(ch: 0 | 1 | 2) {\r\n        super()\r\n        this.#currentCh = ch\r\n        this.ready = this.#setup()\r\n    }\r\n\r\n    async #setup() {\r\n        const html = await fetch(\"pages/map.html\").then((res) => res.text())\r\n        await this.#pages.load(Dom.container, html, { history: [\"ch\" + this.#currentCh] })\r\n\r\n        this.#pages.on(\"ch[012]\", (pages) => {\r\n            const id = pages.getCurrentPageId()\r\n\r\n            switch (id) {\r\n                case \"ch0\":\r\n                    this.#currentCh = 0\r\n                    break\r\n                case \"ch1\":\r\n                    this.#currentCh = 1\r\n                    break\r\n                case \"ch2\":\r\n                    this.#currentCh = 2\r\n                    break\r\n            }\r\n        })\r\n\r\n        this.#initializeMapState()\r\n        this.#setupBackButton()\r\n    }\r\n\r\n    /**\r\n     * マップの状態（矢印、ステージボタン、星など）を初期化・描画する\r\n     */\r\n    #initializeMapState() {\r\n        const stageData = LocalStorage.getStageData()\r\n\r\n        // 1. チャプター遷移矢印の表示制御\r\n        if (stageData[MapConfig.UNLOCK_ARROW_TRIGGERS.TO_CH1].cleared) {\r\n            MapGraphView.showChapterArrow(Dom.container, 0)\r\n        }\r\n        if (stageData[MapConfig.UNLOCK_ARROW_TRIGGERS.TO_CH2].cleared) {\r\n            MapGraphView.showChapterArrow(Dom.container, 1)\r\n        }\r\n\r\n        // 2. 各チャプター（グラフ）ごとのステージ描画制御\r\n        const graphs = Dom.container.querySelectorAll<Graph>(\"x-graph\")\r\n\r\n        graphs.forEach((graph, chapterIndex) => {\r\n            if (!graph) return\r\n\r\n            const svg = graph.querySelector(\"svg\")!\r\n            const stageButtons = svg.querySelectorAll<SVGRectElement>(\".stage\")\r\n\r\n            // 最初のステージは常に表示\r\n            MapGraphView.showStageButton(svg, 0)\r\n\r\n            stageButtons.forEach((button, localStageIndex) => {\r\n                const globalStageId = MapConfig.getGlobalStageId(chapterIndex, localStageIndex)\r\n                const isCleared = stageData[globalStageId]?.cleared\r\n\r\n                // クリア済みの場合の表示更新（星、エッジ、次のステージ解放）\r\n                if (isCleared) {\r\n                    MapGraphView.markupStar(svg, button)\r\n                    MapGraphView.showEdges(svg, localStageIndex)\r\n                    MapGraphView.showConnectedStages(graph, localStageIndex)\r\n                }\r\n\r\n                // クリックイベントの設定\r\n                button.onclick = () => this.#onStageClick(globalStageId)\r\n            })\r\n        })\r\n    }\r\n\r\n    #setupBackButton() {\r\n        this.#pages.before(\"back\", async () => {\r\n            const { SceneTitle } = await import(\"./SceneTitle\")\r\n            SceneChanger.goto(() => new SceneTitle())\r\n            return true\r\n        })\r\n    }\r\n\r\n    /**\r\n     * ステージがクリックされた時の処理\r\n     */\r\n    async #onStageClick(stageId: number) {\r\n        const Z = Dom.container.querySelector(\"#Z\")!\r\n        Z.classList.add(\"fade-in\")\r\n\r\n        const commands = await fetch(`../../assets/stories/start.json`).then((r) => r.json())\r\n        await Serif.say(...commands[stageId])\r\n\r\n        Z.classList.remove(\"fade-in\")\r\n\r\n        const choice = await Serif.ask(\"やる?\", [\"やる\", \"やらない\"])\r\n        if (choice !== 0) return\r\n\r\n        await this.#transitionToGame(stageId)\r\n\r\n        switch (stageId) {\r\n            case 0:\r\n                await this.#playTutorial(0)\r\n                break\r\n            case 4:\r\n                await this.#playTutorial(1)\r\n                break\r\n            case 5:\r\n                await this.#playTutorial(2)\r\n                break\r\n        }\r\n    }\r\n\r\n    async #transitionToGame(stageId: number) {\r\n        const { SceneGame } = await import(\"./SceneGame\")\r\n\r\n        await SceneChanger.goto(() => new SceneGame(this.#currentCh, stageId), {\r\n            fadeOut: Awaits.valeOut,\r\n            fadeIn: Awaits.valeIn,\r\n            msOut: 800,\r\n            msIn: 800,\r\n        })\r\n    }\r\n\r\n    async #playTutorial(index: number) {\r\n        const commands = await fetch(\"../../assets/stories/tutorial.json\").then((res) => res.json())\r\n        await Serif.say(...commands[index])\r\n    }\r\n}\r\n\r\n// MapConfig.ts\r\nconst MapConfig = {\r\n    // 各チャプターの開始ステージIDオフセット\r\n    STAGE_OFFSETS: [0, 7, 13],\r\n\r\n    // 次のチャプターへの矢印を解放するトリガーステージID\r\n    UNLOCK_ARROW_TRIGGERS: {\r\n        TO_CH1: 6,\r\n        TO_CH2: 12,\r\n    },\r\n\r\n    /** チャプターインデックスとローカルインデックスからグローバルなステージIDを計算 */\r\n    getGlobalStageId(chapterIndex: number, localStageIndex: number): number {\r\n        return localStageIndex + (this.STAGE_OFFSETS[chapterIndex] || 0)\r\n    },\r\n}\r\n\r\n// MapGraphView.ts\r\nclass MapGraphView {\r\n    /**\r\n     * SVG内の特定のステージにクリア済みの星マークを追加する\r\n     */\r\n    static markupStar(svg: SVGSVGElement, button: SVGRectElement) {\r\n        const rect = button.getBBox()\r\n        const x = rect.x + rect.width\r\n        const y = rect.y\r\n\r\n        const img = document.createElementNS(\"http://www.w3.org/2000/svg\", \"image\")\r\n        img.classList.add(\"star-icon\")\r\n        img.setAttribute(\"href\", \"assets/images/star.png\")\r\n        img.setAttribute(\"x\", String(x - 12))\r\n        img.setAttribute(\"y\", String(y - 12))\r\n        img.setAttribute(\"width\", \"24\")\r\n        img.setAttribute(\"height\", \"24\")\r\n\r\n        svg.appendChild(img)\r\n    }\r\n\r\n    /**\r\n     * 指定したステージIDに関連するエッジ（道）を表示する\r\n     */\r\n    static showEdges(svg: SVGSVGElement, localStageIndex: number) {\r\n        svg.querySelectorAll(`.path[data-from=\"${localStageIndex}\"], .path[data-to=\"${localStageIndex}\"]`).forEach(\r\n            (edge) => edge.classList.remove(\"hidden\"),\r\n        )\r\n    }\r\n\r\n    /**\r\n     * ステージボタンを表示状態にする\r\n     */\r\n    static showStageButton(svg: SVGSVGElement, localStageIndex: number) {\r\n        svg.querySelectorAll<SVGRectElement>(\".stage\")[localStageIndex]?.classList.remove(\"hidden\")\r\n    }\r\n\r\n    /**\r\n     * 接続されている次のステージ群を表示する\r\n     */\r\n    static showConnectedStages(graph: Graph, localStageIndex: number) {\r\n        graph.getConnectedVertices(localStageIndex).forEach((stage) => stage.classList.remove(\"hidden\"))\r\n    }\r\n\r\n    /**\r\n     * チャプター遷移用の矢印を表示する\r\n     */\r\n    static showChapterArrow(container: HTMLElement, arrowIndex: number) {\r\n        container.querySelectorAll(\".map-arrow-right\")[arrowIndex]?.classList.remove(\"hidden\")\r\n    }\r\n}\r\n"],"file":"SceneMap-CXCdK-zO.js"}