{"version":3,"mappings":"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","names":["parseToNumber","str","defaultValue","RegExpDict","#dict","dict","key","reg","value","Pages","#defaultMSIn","#defaultMSOut","#onHandlers","#leftHandlers","#beforeHandlers","#container","#history","#currentPageId","#loaded","container","html","history","first","page","selector","handler","#setupBackButton","#setupLinkButton","button","depth","msIn","msOut","id","backDepth","option","i","#back","#runBefore","#runLeft","from","to","Awaits","#runOn","result","Scene","SceneTitle","#pages","#setup","res","Dom","#setupFirstPage","pages","SceneMap","__vitePreload","SceneChanger","LocalStorage","#始まり","Serif","commands"],"ignoreList":[],"sources":["../../../src/utils/Utils.ts","../../../src/utils/RegExpDict.ts","../../../src/utils/Pages.ts","../../../src/Scenes/Scene.ts","../../../src/Scenes/SceneTitle.ts"],"sourcesContent":["export function parseToNumber(str: string | undefined | null, defaultValue: number) {\r\n    if (!str) return defaultValue\r\n\r\n    if (Number.isNaN(Number(str))) return defaultValue\r\n\r\n    return Number(str)\r\n}\r\n\r\nexport function maxIndex(numbers: number[]) {\r\n    return numbers.indexOf(Math.max(...numbers))\r\n}\r\n","export class RegExpDict<T> {\r\n    readonly #dict: Record<string, T>\r\n\r\n    constructor(dict: Record<string, T>) {\r\n        this.#dict = dict\r\n    }\r\n\r\n    get(key: string): T | undefined {\r\n        for (const [reg, value] of Object.entries(this.#dict)) {\r\n            if (new RegExp(`^${reg}$`).test(key)) {\r\n                return value\r\n            }\r\n        }\r\n    }\r\n\r\n    *getAll(key: string) {\r\n        for (const [reg, value] of Object.entries(this.#dict)) {\r\n            if (new RegExp(`^${reg}$`).test(key)) {\r\n                yield value\r\n            }\r\n        }\r\n    }\r\n\r\n    getKeys(): string[] {\r\n        return Object.keys(this.#dict)\r\n    }\r\n\r\n    getValues(): T[] {\r\n        return Object.values(this.#dict)\r\n    }\r\n\r\n    add(reg: string, value: T) {\r\n        this.#dict[reg] = value\r\n    }\r\n}\r\n","import { Awaits } from \"./Awaits\"\r\nimport { parseToNumber } from \"./Utils\"\r\nimport { RegExpDict } from \"./RegExpDict\"\r\n\r\ntype OnHandler = (pages: Pages) => void\r\ntype BeforeHandler = (pages: Pages) => Promise<void | boolean>\r\ntype LeftHandler = (pages: Pages) => void\r\n\r\ntype FadeOption = Partial<{ msIn: number; msOut: number }>\r\n\r\nexport class Pages {\r\n    static readonly #defaultMSIn = 250\r\n    static readonly #defaultMSOut = 250\r\n\r\n    readonly pages = new RegExpDict<HTMLElement>({})\r\n\r\n    readonly #onHandlers = new RegExpDict<OnHandler>({})\r\n    readonly #leftHandlers = new RegExpDict<LeftHandler>({})\r\n    readonly #beforeHandlers = new RegExpDict<BeforeHandler>({})\r\n\r\n    #container!: HTMLElement\r\n    #history: string[] = []\r\n    #currentPageId = \"first\" // これは消すべきでない\r\n\r\n    #loaded = false\r\n\r\n    async load(container: HTMLElement, html: string, { history }: { history?: string[] } = {}) {\r\n        if (this.#loaded) {\r\n            throw new Error(\"Pages have already been loaded\")\r\n        }\r\n        this.#loaded = true\r\n\r\n        // Initialize container\r\n        this.#container = container\r\n        this.#container.innerHTML = html\r\n\r\n        // Initialize history\r\n        const first = history && history.length ? history.at(-1)! : \"first\"\r\n        this.#history = history && history.length ? history.slice(0, -1) : []\r\n\r\n        // Initialize pages\r\n        container.querySelectorAll<HTMLElement>(\".page\").forEach((page) => {\r\n            this.pages.add(page.id, page)\r\n            page.classList.add(\"hidden\")\r\n        })\r\n\r\n        await this.goto(first, { msIn: 0, msOut: 0 })\r\n        this.setupButtonsOnclick()\r\n    }\r\n\r\n    getCurrentPageId(): string {\r\n        return this.#currentPageId\r\n    }\r\n\r\n    on(selector: string, handler: OnHandler) {\r\n        this.#onHandlers.add(selector, handler)\r\n    }\r\n\r\n    onLeft(selector: string, handler: LeftHandler) {\r\n        this.#leftHandlers.add(selector, handler)\r\n    }\r\n\r\n    before(selector: string, handler: BeforeHandler) {\r\n        this.#beforeHandlers.add(selector, handler)\r\n    }\r\n\r\n    setupButtonsOnclick() {\r\n        type Button = HTMLElement | SVGElement\r\n\r\n        this.#container.querySelectorAll<Button>(\"[data-back]\").forEach(this.#setupBackButton.bind(this))\r\n        this.#container.querySelectorAll<Button>(\"[data-link]\").forEach(this.#setupLinkButton.bind(this))\r\n    }\r\n\r\n    #setupBackButton(button: HTMLElement | SVGElement) {\r\n        const depth = Number(button.dataset.back) || 1\r\n        const msIn = parseToNumber(button.dataset[\"ms-in\"], Pages.#defaultMSIn)\r\n        const msOut = parseToNumber(button.dataset[\"ms-Out\"], Pages.#defaultMSOut)\r\n\r\n        button.onclick = () => {\r\n            this.back(depth, { msIn, msOut })\r\n        }\r\n    }\r\n\r\n    #setupLinkButton(button: HTMLElement | SVGElement) {\r\n        const id = button.dataset.link || \"first\"\r\n        const msIn = parseToNumber(button.dataset[\"ms-in\"], Pages.#defaultMSIn)\r\n        const msOut = parseToNumber(button.dataset[\"ms-Out\"], Pages.#defaultMSOut)\r\n\r\n        button.onclick = () => {\r\n            this.goto(id, {\r\n                msIn,\r\n                msOut,\r\n            })\r\n        }\r\n    }\r\n\r\n    async back(backDepth: number, option: FadeOption = {}) {\r\n        for (let i = 0; i < backDepth; i++) {\r\n            await this.#back(option)\r\n        }\r\n    }\r\n\r\n    async #back(option: FadeOption = {}) {\r\n        if (this.#history.length === 0) return\r\n        this.#history.pop()\r\n        await this.goto(this.#history.pop()!, option)\r\n    }\r\n\r\n    async goto(id: string, { msIn = Pages.#defaultMSIn, msOut = Pages.#defaultMSOut }: FadeOption = {}) {\r\n        // 入る前に実行される物。キャンセルされたら入らない。\r\n        if (await this.#runBefore(id)) return\r\n\r\n        // 現在のページを去る際に実行される物。\r\n        this.#runLeft(this.#currentPageId)\r\n\r\n        const from = this.pages.get(this.#currentPageId)\r\n        const to = this.pages.get(id)\r\n\r\n        if (from) {\r\n            await Awaits.fadeOut(from, msOut)\r\n            from.classList.add(\"hidden\")\r\n        }\r\n\r\n        // 更新\r\n        this.#history.push(id)\r\n        this.#currentPageId = id\r\n\r\n        // 新しいページに入った時に実行される物。\r\n        this.#runOn(this.#currentPageId)\r\n\r\n        // fade\r\n        if (to) {\r\n            to.classList.remove(\"hidden\")\r\n            await Awaits.fadeIn(to, msIn)\r\n        }\r\n    }\r\n\r\n    async #runBefore(id: string) {\r\n        const result = this.#beforeHandlers.getAll(id).map((handler) => handler(this))\r\n        const p = await Promise.all(result)\r\n        return p.some(Boolean)\r\n    }\r\n\r\n    #runLeft(id: string) {\r\n        this.#leftHandlers.getAll(id).map((handler) => handler(this))\r\n    }\r\n\r\n    #runOn(id: string) {\r\n        requestAnimationFrame(() => {\r\n            this.#onHandlers.getAll(id).forEach((handler) => handler(this))\r\n        })\r\n    }\r\n}\r\n","export abstract class Scene {\r\n    abstract readonly ready: Promise<void>\r\n    async end() {}\r\n}\r\n","import { Dom } from \"../Dom\"\r\nimport { LocalStorage } from \"../LocalStorage\"\r\nimport { Awaits } from \"../utils/Awaits\"\r\nimport { KeyboardOperation } from \"../utils/KeyboardOperation\"\r\nimport { Pages } from \"../utils/Pages\"\r\nimport { Serif } from \"../utils/Serif\"\r\nimport { Scene } from \"./Scene\"\r\nimport { SceneChanger } from \"./SceneChanger\"\r\n\r\nexport class SceneTitle extends Scene {\r\n    readonly ready: Promise<void>\r\n    readonly #pages = new Pages()\r\n\r\n    constructor() {\r\n        super()\r\n        this.ready = this.#setup()\r\n    }\r\n\r\n    async #setup() {\r\n        const html = await fetch(\"pages/title.html\").then((res) => res.text())\r\n        await this.#pages.load(Dom.container, html)\r\n\r\n        this.#setupFirstPage()\r\n\r\n        this.#pages.on(\".*\", (pages) => {\r\n            const page = pages.pages.get(pages.getCurrentPageId())\r\n            if (!page) return\r\n            // KeyboardOperation.update(page)\r\n        })\r\n\r\n        this.#pages.on(\"start\", async (pages) => {\r\n            const { SceneMap } = await import(\"./SceneMap\")\r\n            await SceneChanger.goto(() => new SceneMap(0))\r\n\r\n            if (!LocalStorage.getFlags().includes(\"始まり\")) {\r\n                this.#始まり()\r\n            }\r\n        })\r\n\r\n        this.#pages.before(\"delete-data\", async () => {\r\n            const choice = await Serif.ask(\"ほんとに?\", [\"はい\", \"いいえ\"])\r\n\r\n            if (choice === 0) {\r\n                LocalStorage.clear()\r\n                SceneChanger.goto(() => new SceneTitle())\r\n            }\r\n\r\n            return true\r\n        })\r\n\r\n        this.#pages.before(\"fullscreen\", async (pages) => {\r\n            if (document.fullscreenElement) {\r\n                document.exitFullscreen()\r\n            } else {\r\n                document.documentElement.requestFullscreen()\r\n            }\r\n            return true\r\n        })\r\n    }\r\n\r\n    async #始まり() {\r\n        LocalStorage.addFlag(\"始まり\")\r\n\r\n        const commands = await fetch(\"../../assets/stories/始まり.json\").then((res) => res.json())\r\n        await Serif.say(...commands)\r\n    }\r\n\r\n    #setupFirstPage() {\r\n        const page = this.#pages.pages.get(\"first\")!\r\n\r\n        Awaits.ok().then(() => {\r\n            // KeyboardOperation.update(page)\r\n            page.classList.add(\"show\")\r\n        })\r\n\r\n        // Serif.say(\"test\")\r\n    }\r\n}\r\n"],"file":"SceneTitle-DHXt9q9_.js"}